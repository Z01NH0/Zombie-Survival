<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zombie Survival</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            background: #000;
            color: #fff;
            cursor: crosshair;
        }
        
        #gameCanvas {
            display: block;
            background: #0a0a12;
            width: 100%;
            height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            font-size: 12px;
            color: #ff5555;
            text-shadow: 2px 2px 0 #000;
        }
        
        .stat-bar {
            height: 20px;
            margin: 8px 0;
            border: 3px solid #333;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #healthBarFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ff3333, #ff5555);
            transition: width 0.3s;
        }
        
        #staminaBarFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #55aaff, #77ccff);
            transition: width 0.3s;
        }
        
        #inventory {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #444;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }
        
        .inventory-slot {
            width: 60px;
            height: 60px;
            border: 3px solid #555;
            background: rgba(30, 30, 30, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 8px;
            position: relative;
            transition: all 0.2s;
        }
        
        .inventory-slot.active {
            border: 3px solid #ff5555;
            transform: scale(1.1);
            box-shadow: 0 0 15px #ff5555;
        }
        
        .slot-ammo {
            font-size: 10px;
            margin-top: 5px;
            color: #77ccff;
        }
        
        .cooldown-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            color: #ffcc00;
            background: rgba(0,0,0,0.7);
            padding: 2px;
            border-radius: 3px;
        }
        
        #dayTime {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            color: #ffcc55;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #ffcc55;
        }
        
        #timeLeft {
            position: absolute;
            top: 50px;
            right: 10px;
            font-size: 14px;
            color: #ffcc55;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #ffcc55;
        }
        
        #gameOverScreen, #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
        }
        
        #gameOverScreen h1, #startScreen h1 {
            font-size: 48px;
            color: #ff5555;
            margin-bottom: 30px;
            font-family: 'Bungee', cursive;
            text-shadow: 5px 5px 0 #000;
            letter-spacing: 3px;
        }
        
        #startScreen h1 {
            color: #ffcc55;
            font-size: 64px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #ffcc55, 0 0 20px #ffcc55, 0 0 30px #ffcc55;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #ffcc55, 0 0 20px #ffcc55, 0 0 30px #ffcc55; }
            to { text-shadow: 0 0 20px #ffcc55, 0 0 30px #ffcc55, 0 0 40px #ffcc55; }
        }
        
        .screen-description {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.5;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(to bottom, #ff5555, #cc0000);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            margin: 10px;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #880000;
            text-transform: uppercase;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #880000;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #880000;
        }
        
        #controls {
            margin-top: 30px;
            color: #777;
            font-size: 12px;
            line-height: 2;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #444;
        }
        
        #bloodOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            z-index: 150;
            transition: opacity 0.3s;
        }
        
        #healEffect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            z-index: 151;
            background: radial-gradient(circle, rgba(0,255,0,0.5) 0%, rgba(0,255,0,0) 70%);
            transition: opacity 0.5s;
        }
        
        .night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 30, 0.7);
            pointer-events: none;
            z-index: 120;
        }
        
        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 3px solid #ffcc55;
            border-radius: 10px;
            z-index: 200;
            display: none;
            width: 720px;
        }
        
        #shop h2 {
            color: #ffcc55;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .shop-columns {
            display: flex;
            gap: 20px;
        }
        
        .shop-column {
            flex: 1;
        }
        
        .shop-column-title {
            margin-bottom: 10px;
            text-align: center;
            font-size: 14px;
            padding: 5px;
            border-radius: 5px;
        }
        
        .shop-column.arsenal .shop-column-title {
            background: #ff5555;
            color: #fff;
        }
        
        .shop-column.status .shop-column-title {
            background: #5555ff;
            color: #fff;
        }
        
        .shop-column.potions .shop-column-title {
            background: #55ff55;
            color: #fff;
        }
        
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 5px;
            font-size: 12px;
        }
        
        .shop-item button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }
        
        .potion-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 50%;
        }
        
        .potion-strength {
            background: #ff0000;
        }
        
        .potion-luck {
            background: #ffcc00;
        }
        
        .potion-ammo {
            background: #aaaaaa;
        }
        
        .potion-cooldown {
            background: #00aaff;
        }
        
        #coins {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            color: #ffcc55;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #ffcc55;
            margin-top: 90px;
        }
        
        .grenade {
            position: absolute;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            box-shadow: 0 0 10px 5px rgba(255, 0, 0, 0.7);
            z-index: 110;
        }
        
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,100,0,0.8) 0%, rgba(255,0,0,0) 70%);
            z-index: 110;
            pointer-events: none;
        }
        
        .boss-projectile {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff00ff 0%, #880088 100%);
            border-radius: 50%;
            z-index: 110;
            pointer-events: none;
        }
        
        .boss-vomit {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ff0000 0%, #880000 100%);
            border-radius: 50%;
            z-index: 110;
            pointer-events: none;
        }
        
        #bossMessage {
            position: absolute;
            top: 50px;
            right: 10px;
            font-size: 14px;
            color: #ff5555;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #ff5555;
            display: none;
        }
        
        .laser-beam {
            position: absolute;
            background: linear-gradient(to right, rgba(0, 255, 0, 0.3), rgba(0, 255, 0, 0.8));
            z-index: 110;
            pointer-events: none;
            border-radius: 5px;
        }
        
        #secretWeaponMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ffcc00;
            text-shadow: 0 0 10px #ffcc00, 0 0 20px #ffcc00;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #ffcc00;
            z-index: 300;
            display: none;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        .secret-weapon-effect {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffcc00, transparent);
            pointer-events: none;
            z-index: 299;
            animation: floatAround 3s linear infinite;
        }
        
        @keyframes floatAround {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(360deg); opacity: 0; }
        }
        
        .laser-charge-effect {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: radial-gradient(circle, #00ff00, #00aa00);
            pointer-events: none;
            z-index: 110;
            animation: laserCharge 0.5s infinite alternate;
        }
        
        @keyframes laserCharge {
            from { transform: scale(1); opacity: 0.7; }
            to { transform: scale(1.5); opacity: 1; }
        }
        
        #active-potions {
            position: absolute;
            top: 130px;
            left: 10px;
            z-index: 100;
            font-size: 12px;
            color: #ff5555;
            text-shadow: 2px 2px 0 #000;
            display: flex;
            gap: 10px;
        }
        
        .potion-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid #fff;
        }
        
        .potion-indicator .days-left {
            position: absolute;
            bottom: -15px;
            font-size: 10px;
            color: #ffcc55;
            text-shadow: 1px 1px 0 #000;
        }
        
        .zombie-death-effect {
            position: absolute;
            pointer-events: none;
            z-index: 105;
        }
        
        .boss-death-effect {
            position: absolute;
            pointer-events: none;
            z-index: 106;
        }
        
        .sniper-bullet {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffff00;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 0, 0.7);
            z-index: 110;
        }
        
        .vomit-trail {
            position: absolute;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 5px;
            z-index: 109;
            pointer-events: none;
        }
        
        .poison-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            z-index: 152;
            background: radial-gradient(circle, rgba(0,255,0,0.3) 0%, rgba(0,255,0,0) 70%);
            transition: opacity 0.5s;
        }
        
        .start-screen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1a0000, #00001a, #001a00, #1a1a00);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -1;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .zombie-silhouette {
            position: absolute;
            width: 100px;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50% 50% 40% 40%;
            filter: blur(2px);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }
        
        .silhouette1 {
            top: 20%;
            left: 15%;
            animation-delay: 0s;
        }
        
        .silhouette2 {
            top: 60%;
            left: 80%;
            animation-delay: 1s;
        }
        
        .silhouette3 {
            top: 30%;
            left: 75%;
            animation-delay: 2s;
        }
        
        .silhouette4 {
            top: 70%;
            left: 10%;
            animation-delay: 1.5s;
        }
        
        .blood-splatter {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,0,0,0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(5px);
            z-index: -1;
        }
        
        .splatter1 {
            top: 20%;
            left: 20%;
            transform: rotate(45deg);
        }
        
        .splatter2 {
            top: 60%;
            left: 70%;
            transform: rotate(-20deg);
        }
        
        .splatter3 {
            top: 40%;
            left: 40%;
            transform: rotate(10deg);
        }
        
        .difficulty-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
            max-width: 500px;
        }
        
        .difficulty-title {
            font-size: 18px;
            color: #ffcc55;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #000;
        }
        
        .difficulty-btn {
            padding: 15px;
            font-size: 14px;
            background: linear-gradient(to bottom, #5555ff, #3333aa);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #000088;
            text-align: center;
        }
        
        .difficulty-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #000088;
        }
        
        .difficulty-btn.easy {
            background: linear-gradient(to bottom, #55ff55, #00aa00);
            box-shadow: 0 5px 0 #008800;
        }
        
        .difficulty-btn.easy:hover {
            box-shadow: 0 8px 0 #008800;
        }
        
        .difficulty-btn.hard {
            background: linear-gradient(to bottom, #ff5555, #aa0000);
            box-shadow: 0 5px 0 #880000;
        }
        
        .difficulty-btn.hard:hover {
            box-shadow: 0 8px 0 #880000;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
        }
        
        .stat-item {
            background: rgba(50, 50, 50, 0.7);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #444;
            text-align: left;
            font-size: 12px;
        }
        
        .stat-value {
            color: #ffcc55;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="bloodOverlay"></div>
    <div id="healEffect"></div>
    <div id="poisonEffect" class="poison-effect"></div>
    <div id="nightOverlay" class="night-overlay" style="display: none;"></div>
    
    <div id="ui">
        <div>SA√öDE: <span id="health">100</span>%</div>
        <div class="stat-bar"><div id="healthBarFill"></div></div>
        <div>ENERGIA: <span id="stamina">100</span>%</div>
        <div class="stat-bar"><div id="staminaBarFill"></div></div>
        <div>ZUMBIS: <span id="zombieCount">0</span></div>
        <div>DIA: <span id="day">1</span></div>
    </div>
    
    <div id="active-potions"></div>
    
    <div id="dayTime">‚òÄÔ∏è DIA</div>
    <div id="timeLeft">TEMPO: 15s</div>
    <div id="bossMessage">MATE-O PARA PROSSEGUIR</div>
    <div id="coins">MOEDAS: <span id="coinCount">0</span></div>
    
    <div id="inventory">
        <div class="inventory-slot active">üî™<div class="slot-ammo">-</div></div>
        <div class="inventory-slot">üî´<div class="slot-ammo">0/100</div></div>
        <div class="inventory-slot">üí•<div class="slot-ammo">0/25</div></div>
        <div class="inventory-slot">ü©π<div class="slot-ammo">0/10</div></div>
        <div class="inventory-slot">üß®<div class="slot-ammo">0/5</div></div>
        <div class="inventory-slot">‚ùì<div class="slot-ammo">?</div></div>
    </div>
    
    <div id="secretWeaponMessage">‚≠êVOC√ä DESBLOQUEOU A ARMA SECRETA‚≠ê</div>
    
    <div id="shop">
        <h2>LOJA DE MELHORIAS</h2>
        <div class="shop-columns">
            <div class="shop-column arsenal">
                <div class="shop-column-title">ARSENAL</div>
                <div class="shop-item">
                    <span>Muni√ß√£o Pistola</span>
                    <button id="buyAmmo">ü™ô12 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span>Muni√ß√£o Shotgun</span>
                    <button id="buyShotgunAmmo">ü™ô25 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span>Kit M√©dico</span>
                    <button id="buyMedkit">ü™ô8 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span>Granadas</span>
                    <button id="buyGrenades">ü™ô50 COMPRAR</button>
                </div>
            </div>
            <div class="shop-column status">
                <div class="shop-column-title">STATUS</div>
                <div class="shop-item">
                    <span>+10% Vida</span>
                    <button id="buyHealth">ü™ô20 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span>+10% Dano</span>
                    <button id="buyDamage">ü™ô15 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span>+10% Stamina</span>
                    <button id="buySpeed">ü™ô18 COMPRAR</button>
                </div>
            </div>
            <div class="shop-column potions">
                <div class="shop-column-title">PO√á√ïES</div>
                <div class="shop-item">
                    <span><div class="potion-icon potion-strength"></div> Po√ß√£o de For√ßa</span>
                    <button id="buyStrengthPotion">ü™ô120 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span><div class="potion-icon potion-luck"></div> Po√ß√£o de Sorte</span>
                    <button id="buyLuckPotion">ü™ô200 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span><div class="potion-icon potion-ammo"></div> Po√ß√£o de Muni√ß√£o Inf.</span>
                    <button id="buyAmmoPotion">ü™ô250 COMPRAR</button>
                </div>
                <div class="shop-item">
                    <span><div class="potion-icon potion-cooldown"></div> Po√ß√£o de Cooldown</span>
                    <button id="buyCooldownPotion">ü™ô150 COMPRAR</button>
                </div>
            </div>
        </div>
        <button id="closeShop" style="width: 100%; margin-top: 15px;">FECHAR LOJA</button>
    </div>
    
    <div id="startScreen">
        <div class="start-screen-bg"></div>
        <div class="zombie-silhouette silhouette1"></div>
        <div class="zombie-silhouette silhouette2"></div>
        <div class="zombie-silhouette silhouette3"></div>
        <div class="zombie-silhouette silhouette4"></div>
        <div class="blood-splatter splatter1"></div>
        <div class="blood-splatter splatter2"></div>
        <div class="blood-splatter splatter3"></div>
        
        <h1>ZOMBIE SURVIVAL</h1>
        <p class="screen-description">Sobreviva o m√°ximo que puder em um mundo infestado de zumbis. Durante o dia, compre melhorias. √Ä noite, enfrente hordas de mortos-vivos cada vez mais perigosos.</p>
        
        <div class="difficulty-title">ESCOLHA SUA DIFICULDADE</div>
        <div class="difficulty-container">
            <button class="difficulty-btn easy" id="easyButton">BEB√äZINHO DA MAM√ÉE</button>
            <button class="difficulty-btn" id="normalButton">CLT</button>
            <button class="difficulty-btn hard" id="hardButton">VERDADEIRO APOCALIPSE</button>
        </div>
        
        <div id="controls">
            WASD: MOVER | SHIFT: CORRER | 1-6: TROCAR ARMA <br>
            CLIQUE: ATACAR | E: ABRIR/FECHAR LOJA
        </div>
    </div>
    
    <div id="gameOverScreen" style="display: none;">
        <h1>FIM DE JOGO</h1>
        <p class="screen-description">Voc√™ sobreviveu <span id="survivedDays">0</span> dias no apocalipse zumbi.</p>
        
        <div class="stats-container">
            <div class="stat-item">ZUMBIS ELIMINADOS:<div class="stat-value" id="statZombiesKilled">0</div></div>
            <div class="stat-item">MOEDAS GASTAS:<div class="stat-value" id="statCoinsSpent">0</div></div>
            <div class="stat-item">MUNI√á√ÉO USADA:<div class="stat-value" id="statAmmoUsed">0</div></div>
            <div class="stat-item">BANDAGENS USADAS:<div class="stat-value" id="statMedkitsUsed">0</div></div>
            <div class="stat-item">GRANADAS USADAS:<div class="stat-value" id="statGrenadesUsed">0</div></div>
            <div class="stat-item">BOSSES ELIMINADOS:<div class="stat-value" id="statBossesKilled">0</div></div>
        </div>
        
        <button id="restartButton">VOLTAR AO MENU</button>
    </div>
    
    <script>
        const config = {
            width: 1600,
            height: 900,
            playerSpeed: 3,
            zombieSpawnRate: 1500,
            nightDuration: 45000,
            dayDuration: 20000,
            mapTiles: 25,
            itemSpawnChance: 0.05,
            itemSpawnInterval: 2000,
            baseZombiesPerNight: 5,
            zombieIncreasePerDay: 4
        };
        
        // Configura√ß√µes de dificuldade
        const difficultySettings = {
            easy: {
                coinMultiplier: 3,
                itemDropMultiplier: 3,
                zombieHealthMultiplier: 0.3,
                zombieSpawnMultiplier: 0.2,
                shopPriceMultiplier: 1
            },
            normal: {
                coinMultiplier: 1,
                itemDropMultiplier: 1,
                zombieHealthMultiplier: 1,
                zombieSpawnMultiplier: 1,
                shopPriceMultiplier: 1
            },
            hard: {
                coinMultiplier: 0.5,
                itemDropMultiplier: 0.5,
                zombieHealthMultiplier: 2.4,
                zombieSpawnMultiplier: 3.3,
                shopPriceMultiplier: 1.5
            }
        };
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = config.width;
        canvas.height = config.height;

        const gameState = {
            player: null,
            zombies: [],
            bullets: [],
            acidBullets: [],
            bossProjectiles: [],
            bossVomits: [],
            grenades: [],
            explosions: [],
            obstacles: [],
            items: [],
            isNight: false,
            day: 1,
            gameTime: 0,
            gameOver: false,
            inventory: [
                { type: 'knife', ammo: null, maxAmmo: null },
                { type: 'pistol', ammo: 0, maxAmmo: 100 },
                { type: 'shotgun', ammo: 0, maxAmmo: 25 },
                { type: 'medkit', ammo: 0, maxAmmo: 10 },
                { type: 'grenade', ammo: 0, maxAmmo: 5 },
                { type: 'empty', ammo: null, maxAmmo: null } 
            ],
            selectedSlot: 0,
            map: [],
            bloodEffect: 0,
            attackCooldown: 0,
            knifeAngle: 0,
            isAttacking: false,
            coins: 0,
            playerDamageMultiplier: 1,
            playerDefenseMultiplier: 1,
            zombiesToSpawn: 0,
            zombiesSpawned: 0,
            shopOpen: false,
            itemSpawnTimer: 0,
            bossSpawned: false,
            bossAlive: false,
            pistolCooldown: 0,
            shotgunCooldown: 0,
            laserRifleCooldown: 0,
            medkitCooldown: 0,
            grenadeCooldown: 0,
            hasLaserRifle: false,
            laserBeams: [], 
            laserChargeEffects: [], 
            sniperBullets: [],
            activePotions: {
                strength: { active: false, daysLeft: 0 },
                luck: { active: false, daysLeft: 0 },
                infiniteAmmo: { active: false, daysLeft: 0 },
                cooldown: { active: false, daysLeft: 0 }
            },
            shopPrices: {
                ammo: 12,
                shotgunAmmo: 25,
                medkit: 8,
                grenades: 40,
                health: 20,
                damage: 15,
                speed: 18,
                strengthPotion: 120,
                luckPotion: 200,
                ammoPotion: 250,
                cooldownPotion: 150
            },
            deathEffects: [],
            bossVomitCharging: false,
            bossVomitChargeTime: 0,
            difficulty: 'normal',
            stats: {
                zombiesKilled: 0,
                coinsSpent: 0,
                ammoUsed: 0,
                medkitsUsed: 0,
                grenadesUsed: 0,
                bossesKilled: 0
            },
            baseCooldowns: {
                pistol: 30,
                shotgun: 60,
                medkit: 150,
                grenade: 300,
                laserRifle: 600
            },
            potionCooldowns: {
                pistol: 18,
                shotgun: 30,
                medkit: 90,
                grenade: 180,
                laserRifle: 300
            }
        };

        function createPlayerSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#55aaff';
            ctx.fillRect(10, 10, 30, 40);
            
            ctx.fillStyle = '#ffccaa';
            ctx.beginPath();
            ctx.arc(25, 15, 10, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }

        function createZombieSprite(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 40;
            canvas.height = 40;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            ctx.fillRect(5, 10, 30, 30);
            
            ctx.fillStyle = '#8fbb6b';
            ctx.beginPath();
            ctx.arc(20, 15, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#a00';
            ctx.beginPath();
            ctx.arc(15, 12, 2, 0, Math.PI * 2);
            ctx.arc(25, 12, 3, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }

        function createBossSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 120;
            canvas.height = 120;
            const ctx = canvas.getContext('2d');
            
            // Corpo inchado e deformado
            const gradient = ctx.createRadialGradient(60, 60, 0, 60, 60, 60);
            gradient.addColorStop(0, '#880000');
            gradient.addColorStop(1, '#440000');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(60, 70, 45, 55, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Espinhos nas costas
            ctx.fillStyle = '#660000';
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const x = 60 + Math.cos(angle) * 40;
                const y = 70 + Math.sin(angle) * 50;
                ctx.beginPath();
                ctx.moveTo(60, 70);
                ctx.lineTo(x, y);
                ctx.lineWidth = 5;
                ctx.stroke();
            }
            
            // Cabe√ßa
            ctx.fillStyle = '#aa0000';
            ctx.beginPath();
            ctx.arc(60, 30, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // Olhos brilhantes
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(50, 25, 5, 0, Math.PI * 2);
            ctx.arc(70, 25, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Boca aberta com dentes
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(60, 35, 15, 0, Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 8; i++) {
                const x = 50 + i * 3;
                ctx.fillRect(x, 30, 2, 8);
            }
            
            // Bra√ßos deformados
            ctx.fillStyle = '#880000';
            ctx.fillRect(15, 50, 20, 10);
            ctx.fillRect(85, 50, 20, 10);
            
            // Detalhes de veias
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 1;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(20 + i * 10, 50);
                ctx.lineTo(25 + i * 10, 30);
                ctx.stroke();
            }
            
            return canvas;
        }

        function createSniperZombieSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 40;
            canvas.height = 40;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#5555ff';
            ctx.fillRect(5, 10, 30, 30);
            
            ctx.fillStyle = '#8fbb6b';
            ctx.beginPath();
            ctx.arc(20, 15, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#a00';
            ctx.beginPath();
            ctx.arc(15, 12, 2, 0, Math.PI * 2);
            ctx.arc(25, 12, 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#333';
            ctx.fillRect(25, 5, 15, 5);
            
            return canvas;
        }

        function createItemSprite(emoji, bgColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 30;
            canvas.height = 30;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = bgColor;
            ctx.beginPath();
            ctx.arc(15, 15, 15, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.fillText(emoji, 15, 15);
            
            return canvas;
        }

        function createWeaponSprite(handleColor, barrelColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 20;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#5a3a1a';
            ctx.fillRect(0, 5, 15, 10);
            
            ctx.fillStyle = handleColor;
            ctx.fillRect(15, 5, 20, 10);
            
            ctx.fillStyle = barrelColor;
            ctx.fillRect(35, 7, 25, 6);
            
            return canvas;
        }

        function createShotgunSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 70;
            canvas.height = 25;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#5a3a1a';
            ctx.fillRect(0, 5, 20, 15);
            
            ctx.fillStyle = '#777';
            ctx.fillRect(20, 5, 25, 15);
            
            ctx.fillStyle = '#ffaa00';
            ctx.fillRect(45, 5, 25, 6);
            ctx.fillRect(45, 14, 25, 6);
            
            return canvas;
        }

        function createKnifeSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 20;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#aaa';
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(60, 10);
            ctx.lineTo(20, 20);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = '#5a3a1a';
            ctx.fillRect(0, 5, 20, 10);
            
            return canvas;
        }

        function createLaserRifleSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 25;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 5, 25, 15);
            
            ctx.fillStyle = '#555';
            ctx.fillRect(25, 5, 30, 15);
            
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(55, 7, 25, 5);
            
            ctx.fillStyle = '#00aa00';
            ctx.fillRect(50, 5, 5, 15);
            ctx.fillRect(60, 5, 5, 15);
            
            return canvas;
        }

        function createMedkitSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 40;
            canvas.height = 30;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(5, 5, 30, 20);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(15, 8, 10, 4);
            ctx.fillRect(18, 5, 4, 15);
            
            return canvas;
        }

        function createGrenadeSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 30;
            canvas.height = 30;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(15, 15, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#FF4500';
            ctx.fillRect(15, 5, 3, 20);
            ctx.fillRect(5, 15, 20, 3);
            
            return canvas;
        }

        function createTerrainSprite(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 64, 64);
            
            if (color !== '#555555') {
                ctx.strokeStyle = color === '#3a5c8f' ? '#2a4c7f' : '#2a4a2a';
                for (let i = 0; i < 10; i++) {
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * 64, Math.random() * 64);
                    ctx.lineTo(Math.random() * 64, Math.random() * 64);
                    ctx.stroke();
                }
            }
            
            return canvas;
        }

        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 40;
                this.height = 40;
                this.speed = config.playerSpeed;
                this.health = 100;
                this.maxHealth = 100;
                this.stamina = 100;
                this.maxStamina = 100;
                this.direction = { x: 0, y: 0 };
                this.lastShot = 0;
                this.isRunning = false;
                this.angle = 0;
                this.knifeAngle = 0;
                this.isAttacking = false;
                this.damageMultiplier = 1;
                this.defenseMultiplier = 1;
                this.laserRifleCharging = false;
                this.laserRifleChargeTime = 0;
                this.baseDamageMultiplier = 1;
                this.baseDefenseMultiplier = 1;
                this.baseMaxHealth = 100;
                this.poisoned = false;
                this.poisonTimer = 0;
                this.poisonDamage = 0;
            }

            update() {
                const speedMultiplier = this.isRunning ? (this.stamina > 0 ? 1.8 : 1) : 1;
                this.x += this.direction.x * this.speed * speedMultiplier;
                this.y += this.direction.y * this.speed * speedMultiplier;

                this.x = Math.max(0, Math.min(config.width - this.width, this.x));
                this.y = Math.max(0, Math.min(config.height - this.height, this.y));

                if (this.isRunning) {
                    this.stamina -= 0.3;
                    if (this.stamina <= 0) {
                        this.stamina = 0;
                        this.isRunning = false;
                    }
                } else {
                    this.stamina += 0.15;
                    if (this.stamina > this.maxStamina) this.stamina = this.maxStamina;
                }

                document.getElementById('health').textContent = Math.floor(this.health);
                document.getElementById('healthBarFill').style.width = `${(this.health / this.maxHealth) * 100}%`;
                document.getElementById('stamina').textContent = Math.floor(this.stamina);
                document.getElementById('staminaBarFill').style.width = `${(this.stamina / this.maxStamina) * 100}%`;

                if (this.isAttacking) {
                    this.knifeAngle += 0.3;
                    if (this.knifeAngle >= Math.PI) {
                        this.knifeAngle = 0;
                        this.isAttacking = false;
                    }
                }

                if (this.laserRifleCharging) {
                    this.laserRifleChargeTime++;
                    
                    if (this.laserRifleChargeTime % 10 === 0) {
                        const barrelX = this.x + this.width / 2 + Math.cos(this.angle) * 80;
                        const barrelY = this.y + this.height / 2 + Math.sin(this.angle) * 80;
                        
                        gameState.laserChargeEffects.push({
                            x: barrelX,
                            y: barrelY,
                            timer: 30,
                            size: 5 + Math.random() * 10
                        });
                    }
                    
                    if (this.laserRifleChargeTime >= 180) {
                        this.laserRifleCharging = false;
                        this.laserRifleChargeTime = 0;
                        this.fireLaserRifle();
                    }
                }

                if (this.poisoned) {
                    this.poisonTimer--;
                    if (this.poisonTimer <= 0) {
                        this.poisoned = false;
                        document.getElementById('poisonEffect').style.opacity = '0';
                    } else if (this.poisonTimer % 60 === 0) {
                        this.takeDamage(this.poisonDamage, true);
                    }
                }

                for (let i = gameState.items.length - 1; i >= 0; i--) {
                    const item = gameState.items[i];
                    if (
                        this.x < item.x + item.width &&
                        this.x + this.width > item.x &&
                        this.y < item.y + item.height &&
                        this.y + this.height > item.y
                    ) {
                        this.pickupItem(item, i);
                    }
                }

                for (let i = gameState.acidBullets.length - 1; i >= 0; i--) {
                    const acid = gameState.acidBullets[i];
                    if (
                        this.x < acid.x + acid.width &&
                        this.x + this.width > acid.x &&
                        this.y < acid.y + acid.height &&
                        this.y + this.height > acid.y
                    ) {
                        this.takeDamage(5);
                        gameState.acidBullets.splice(i, 1);
                    }
                }
                
                for (let i = gameState.bossProjectiles.length - 1; i >= 0; i--) {
                    const projectile = gameState.bossProjectiles[i];
                    if (
                        this.x < projectile.x + projectile.width &&
                        this.x + this.width > projectile.x &&
                        this.y < projectile.y + projectile.height &&
                        this.y + this.height > projectile.y
                    ) {
                        this.takeDamage(15);
                        gameState.bossProjectiles.splice(i, 1);
                    }
                }
                
                for (let i = gameState.bossVomits.length - 1; i >= 0; i--) {
                    const vomit = gameState.bossVomits[i];
                    if (
                        this.x < vomit.x + vomit.width &&
                        this.x + this.width > vomit.x &&
                        this.y < vomit.y + vomit.height &&
                        this.y + this.height > vomit.y
                    ) {
                        this.takeDamage(20);
                        this.applyPoison(2, 180);
                        gameState.bossVomits.splice(i, 1);
                        
                        createParticle(
                            vomit.x, vomit.y,
                            (Math.random() - 0.5) * 4,
                            (Math.random() - 0.5) * 4,
                            '#ff0000',
                            60
                        );
                    }
                }
                
                for (let i = gameState.sniperBullets.length - 1; i >= 0; i--) {
                    const bullet = gameState.sniperBullets[i];
                    if (
                        this.x < bullet.x + bullet.width &&
                        this.x + this.width > bullet.x &&
                        this.y < bullet.y + bullet.height &&
                        this.y + this.height > bullet.y
                    ) {
                        this.takeDamage(15);
                        gameState.sniperBullets.splice(i, 1);
                    }
                }
            }

            applyPoison(damagePerSecond, duration) {
                this.poisoned = true;
                this.poisonTimer = duration;
                this.poisonDamage = damagePerSecond;
                document.getElementById('poisonEffect').style.opacity = '0.5';
            }

            pickupItem(item, index) {
                if (item.type === 'coin') {
                    gameState.coins += item.value;
                    gameState.items.splice(index, 1);
                    updateCoinUI();
                    return;
                }

                if (item.type === 'pistolAmmo') {
                    for (let i = 0; i < gameState.inventory.length; i++) {
                        if (gameState.inventory[i].type === 'pistol') {
                            const maxAmmo = gameState.inventory[i].maxAmmo;
                            const currentAmmo = gameState.inventory[i].ammo;
                            const ammoToAdd = Math.min(12, maxAmmo - currentAmmo);
                            
                            gameState.inventory[i].ammo += ammoToAdd;
                            gameState.items.splice(index, 1);
                            updateInventoryUI();
                            return;
                        }
                    }
                } else if (item.type === 'shotgunAmmo') {
                    for (let i = 0; i < gameState.inventory.length; i++) {
                        if (gameState.inventory[i].type === 'shotgun') {
                            const maxAmmo = gameState.inventory[i].maxAmmo;
                            const currentAmmo = gameState.inventory[i].ammo;
                            const ammoToAdd = Math.min(5, maxAmmo - currentAmmo);
                            
                            gameState.inventory[i].ammo += ammoToAdd;
                            gameState.items.splice(index, 1);
                            updateInventoryUI();
                            return;
                        }
                    }
                } else if (item.type === 'laserAmmo') {
                    for (let i = 0; i < gameState.inventory.length; i++) {
                        if (gameState.inventory[i].type === 'laserRifle') {
                            gameState.inventory[i].ammo += 25;
                            gameState.items.splice(index, 1);
                            updateInventoryUI();
                            return;
                        }
                    }
                } else if (item.type === 'laserRifle') {
                    gameState.hasLaserRifle = true;
                    gameState.items.splice(index, 1);
                    gameState.inventory[5] = { type: 'laserRifle', ammo: 10, maxAmmo: null };
                    updateInventoryUI();
                    
                    showSecretWeaponMessage();
                    return;
                }

                for (let i = 0; i < gameState.inventory.length; i++) {
                    if (gameState.inventory[i].type === item.type) {
                        if (gameState.inventory[i].ammo !== null) {
                            const maxAmmo = gameState.inventory[i].maxAmmo;
                            const currentAmmo = gameState.inventory[i].ammo;
                            
                            if (currentAmmo < maxAmmo) {
                                gameState.inventory[i].ammo += 1;
                                gameState.items.splice(index, 1);
                                updateInventoryUI();
                            }
                            return;
                        }
                    } else if (gameState.inventory[i].type === 'empty') {
                        gameState.inventory[i] = { 
                            type: item.type, 
                            ammo: 1, 
                            maxAmmo: getMaxAmmoForItem(item.type) 
                        };
                        gameState.items.splice(index, 1);
                        updateInventoryUI();
                        return;
                    }
                }
            }

            draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.beginPath();
                ctx.ellipse(
                    this.x + this.width / 2,
                    this.y + this.height - 5,
                    this.width / 2,
                    this.width / 6,
                    0, 0, Math.PI * 2
                );
                ctx.fill();
                
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.rotate(this.angle);
                ctx.drawImage(
                    sprites.player,
                    -this.width / 2,
                    -this.height / 2,
                    this.width,
                    this.height
                );
                
                const weaponType = gameState.inventory[gameState.selectedSlot].type;
                const weaponAmmo = gameState.inventory[gameState.selectedSlot].ammo;
                
                if (weaponType === 'knife' && this.isAttacking) {
                    ctx.save();
                    ctx.rotate(this.knifeAngle - Math.PI / 4);
                    ctx.drawImage(
                        sprites.weapons.knife,
                        -sprites.weapons.knife.width / 2 + 20,
                        -sprites.weapons.knife.height / 2
                    );
                    ctx.restore();
                } else if (weaponType === 'pistol') {
                    ctx.drawImage(
                        sprites.weapons.pistol,
                        15,
                        -sprites.weapons.pistol.height / 2
                    );
                } else if (weaponType === 'shotgun') {
                    ctx.drawImage(
                        sprites.weapons.shotgun,
                        15,
                        -sprites.weapons.shotgun.height / 2
                    );
                } else if (weaponType === 'laserRifle') {
                    ctx.drawImage(
                        sprites.weapons.laserRifle,
                        15,
                        -sprites.weapons.laserRifle.height / 2
                    );
                    
                    if (this.laserRifleCharging) {
                        ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
                        ctx.beginPath();
                        ctx.arc(60, 0, 10 + (this.laserRifleChargeTime / 10), 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (weaponType === 'medkit' && weaponAmmo > 0) {
                    ctx.drawImage(
                        sprites.weapons.medkit,
                        15,
                        -sprites.weapons.medkit.height / 2
                    );
                } else if (weaponType === 'grenade' && weaponAmmo > 0) {
                    ctx.drawImage(
                        sprites.weapons.grenade,
                        15,
                        -sprites.weapons.grenade.height / 2
                    );
                }
                
                ctx.restore();
            }

            takeDamage(amount, ignoreDefense = false) {
                if (!ignoreDefense) {
                    amount = amount * (1 - this.defenseMultiplier * 0.5);
                }
                
                this.health -= amount;
                gameState.bloodEffect = 1;
                document.getElementById('bloodOverlay').style.opacity = '0.7';
                setTimeout(() => {
                    document.getElementById('bloodOverlay').style.opacity = '0';
                }, 300);
                
                if (this.health <= 0) {
                    this.health = 0;
                    gameState.gameOver = true;
                    showGameOverScreen();
                }
            }

            meleeAttack() {
                if (gameState.attackCooldown > 0 || this.isAttacking) return;
                
                this.isAttacking = true;
                this.knifeAngle = 0;
                gameState.attackCooldown = 30;
                
                const attackRange = 70;
                const attackAngle = this.angle;
                const attackArc = Math.PI / 2;
                
                gameState.zombies.forEach(zombie => {
                    const dx = zombie.x + zombie.width / 2 - (this.x + this.width / 2);
                    const dy = zombie.y + zombie.height / 2 - (this.y + this.height / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < attackRange) {
                        const angleToZombie = Math.atan2(dy, dx);
                        const angleDiff = Math.abs(normalizeAngle(angleToZombie - attackAngle));
                        
                        if (angleDiff < attackArc / 2) {
                            zombie.takeDamage(25 * this.damageMultiplier);
                        }
                    }
                });
                
                this.stamina -= 10;
                if (this.stamina < 0) this.stamina = 0;
            }

            heal(amount) {
                this.health = Math.min(this.health + amount, this.maxHealth);
                document.getElementById('healEffect').style.opacity = '0.7';
                setTimeout(() => {
                    document.getElementById('healEffect').style.opacity = '0';
                }, 500);
            }

            increaseMaxHealth(amount) {
                this.maxHealth = Math.floor(this.maxHealth * 1.1);
                this.health = Math.floor(this.health * 1.1);
            }

            increaseMaxStamina(amount) {
                this.maxStamina = Math.floor(this.maxStamina * 1.1);
                this.stamina = Math.floor(this.stamina * 1.1);
            }

            increaseDamage(multiplier) {
                this.damageMultiplier *= 1.1;
                this.baseDamageMultiplier = this.damageMultiplier;
            }

            increaseDefense(multiplier) {
                this.defenseMultiplier += 0.5;
                this.baseDefenseMultiplier = this.defenseMultiplier;
            }

            increaseSpeed(amount) {
                this.speed *= 1.1;
            }

            useMedkit() {
                if (gameState.inventory[3].ammo > 0 && gameState.medkitCooldown <= 0) {
                    this.heal(this.maxHealth * 0.15);
                    if (!gameState.activePotions.infiniteAmmo.active) {
                        gameState.inventory[3].ammo--;
                        gameState.stats.medkitsUsed++;
                    }
                    gameState.medkitCooldown = gameState.activePotions.cooldown.active ? 
                        gameState.potionCooldowns.medkit : gameState.baseCooldowns.medkit;
                    updateInventoryUI();
                    return true;
                }
                return false;
            }

            throwGrenade(targetX, targetY) {
                if (gameState.inventory[4].ammo > 0 && gameState.grenadeCooldown <= 0) {
                    const startX = this.x + this.width / 2;
                    const startY = this.y + this.height / 2;
                    
                    const angle = Math.atan2(
                        targetY - startY,
                        targetX - startX
                    );
                    
                    gameState.grenades.push({
                        x: startX,
                        y: startY,
                        vx: Math.cos(angle) * 8,
                        vy: Math.sin(angle) * 8,
                        timer: 90,
                        exploded: false,
                        distanceTraveled: 0,
                        maxDistance: 500,
                        flashTimer: 0,
                        stuckZombie: null
                    });
                    
                    if (!gameState.activePotions.infiniteAmmo.active) {
                        gameState.inventory[4].ammo--;
                        gameState.stats.grenadesUsed++;
                    }
                    gameState.grenadeCooldown = gameState.activePotions.cooldown.active ? 
                        gameState.potionCooldowns.grenade : gameState.baseCooldowns.grenade;
                    updateInventoryUI();
                    return true;
                }
                return false;
            }

            startLaserRifleCharge() {
                if (this.laserRifleCharging || gameState.laserRifleCooldown > 0) return false;
                
                this.laserRifleCharging = true;
                this.laserRifleChargeTime = 0;
                return true;
            }

            fireLaserRifle() {
                const startX = this.x + this.width / 2 + Math.cos(this.angle) * 140;
                const startY = this.y + this.height / 2 + Math.sin(this.angle) * 140;
                
                const endX = startX + Math.cos(this.angle) * 2000;
                const endY = startY + Math.sin(this.angle) * 2000;
                
                gameState.laserBeams.push({
                    startX: startX,
                    startY: startY,
                    endX: endX,
                    endY: endY,
                    angle: this.angle,
                    timer: 80,
                    damageTimer: 0,
                    width: 90
                });
                
                gameState.laserRifleCooldown = gameState.activePotions.cooldown.active ? 
                    gameState.potionCooldowns.laserRifle : gameState.baseCooldowns.laserRifle;
                
                return true;
            }
            
            applyStrengthPotion() {
                this.defenseMultiplier = this.baseDefenseMultiplier + 0.5;
            }
            
            removeStrengthPotion() {
                this.defenseMultiplier = this.baseDefenseMultiplier;
            }
            
            applyCooldownPotion() {
                // A po√ß√£o de cooldown agora define os cooldowns espec√≠ficos
                // que s√£o aplicados quando a po√ß√£o est√° ativa
            }
            
            removeCooldownPotion() {
                // Os cooldowns voltam ao normal quando a po√ß√£o expira
            }
        }

        function showSecretWeaponMessage() {
            const message = document.getElementById('secretWeaponMessage');
            message.style.display = 'block';
            
            for (let i = 0; i < 20; i++) {
                const effect = document.createElement('div');
                effect.className = 'secret-weapon-effect';
                effect.style.left = `${Math.random() * 100}%`;
                effect.style.top = `${Math.random() * 100}%`;
                effect.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
                effect.style.setProperty('--ty', `${(Math.random() - 0.5) * 200}px`);
                effect.style.animationDelay = `${Math.random() * 2}s`;
                document.body.appendChild(effect);
                
                setTimeout(() => {
                    effect.remove();
                }, 3000);
            }
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        function showGameOverScreen() {
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('survivedDays').textContent = gameState.day;
            document.getElementById('statZombiesKilled').textContent = gameState.stats.zombiesKilled;
            document.getElementById('statCoinsSpent').textContent = gameState.stats.coinsSpent;
            document.getElementById('statAmmoUsed').textContent = gameState.stats.ammoUsed;
            document.getElementById('statMedkitsUsed').textContent = gameState.stats.medkitsUsed;
            document.getElementById('statGrenadesUsed').textContent = gameState.stats.grenadesUsed;
            document.getElementById('statBossesKilled').textContent = gameState.stats.bossesKilled;
        }

        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            let param = -1;
            if (len_sq !== 0) param = dot / len_sq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        class AcidBullet {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.speed = 8;
                this.angle = angle;
                this.lifetime = 100;
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.lifetime--;
            }

            draw() {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class BossProjectile {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.speed = 5;
                this.angle = angle;
                this.lifetime = 300;
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.lifetime--;
            }

            draw() {
                ctx.fillStyle = 'rgba(255, 0, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class BossVomit {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.speed = 6;
                this.angle = angle;
                this.lifetime = 500;
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.lifetime--;
                
                gameState.bossVomits.push({
                    x: this.x,
                    y: this.y,
                    width: 10,
                    height: 10,
                    timer: 10
                });
            }

            draw() {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class SniperBullet {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.width = 8;
                this.height = 8;
                this.speed = 12;
                this.angle = angle;
                this.lifetime = 2000; // Aumentado para ter alcance maior
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.lifetime--;
            }

            draw() {
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(
                    this.x - Math.cos(this.angle) * 15,
                    this.y - Math.sin(this.angle) * 15
                );
                ctx.lineTo(this.x, this.y);
                ctx.stroke();
            }
        }

        const particles = [];
        
        function createParticle(x, y, vx, vy, color, lifetime) {
            particles.push({
                x, y, vx, vy, color, lifetime, maxLifetime: lifetime
            });
        }
        
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.lifetime--;
                
                if (p.lifetime <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        function drawParticles() {
            particles.forEach(p => {
                const alpha = p.lifetime / p.maxLifetime;
                ctx.fillStyle = `${p.color}${Math.floor(alpha * 255).toString(16).padStart(2, '0')}`;
                ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
            });
        }

        function generateMap() {
            const tileSize = Math.max(config.width, config.height) / config.mapTiles;
            const map = [];
            
            for (let y = 0; y < config.mapTiles; y++) {
                map[y] = [];
                for (let x = 0; x < config.mapTiles; x++) {
                    const noise = Math.random();
                    
                    if (noise < 0.1) {
                        map[y][x] = 'water';
                    } else if (noise < 0.3) {
                        map[y][x] = 'road';
                    } else if (noise < 0.35) {
                        map[y][x] = 'building';
                    } else {
                        map[y][x] = 'grass';
                    }
                }
            }
            
            return map;
        }
        
        function drawMap() {
            const tileSize = Math.max(config.width, config.height) / config.mapTiles;
            
            for (let y = 0; y < gameState.map.length; y++) {
                for (let x = 0; x < gameState.map[y].length; x++) {
                    const tileType = gameState.map[y][x];
                    let sprite;
                    
                    switch (tileType) {
                        case 'water': sprite = sprites.terrain.water; break;
                        case 'road': sprite = sprites.terrain.road; break;
                        case 'building': sprite = sprites.terrain.building; break;
                        default: sprite = sprites.terrain.grass;
                    }
                    
                    ctx.drawImage(
                        sprite,
                        x * tileSize,
                        y * tileSize,
                        tileSize,
                        tileSize
                    );
                }
            }
        }

        function initGame() {
            gameState.player = new Player(config.width / 2, config.height / 2);
            gameState.zombies = [];
            gameState.bullets = [];
            gameState.acidBullets = [];
            gameState.bossProjectiles = [];
            gameState.bossVomits = [];
            gameState.grenades = [];
            gameState.explosions = [];
            gameState.items = [];
            gameState.laserBeams = [];
            gameState.laserChargeEffects = [];
            gameState.sniperBullets = [];
            gameState.deathEffects = [];
            gameState.day = 1;
            gameState.gameTime = 0;
            gameState.gameOver = false;
            gameState.attackCooldown = 0;
            gameState.map = generateMap();
            gameState.coins = 0;
            gameState.playerDamageMultiplier = 1;
            gameState.playerDefenseMultiplier = 1;
            
            // Aplicar configura√ß√µes de dificuldade
            const difficulty = difficultySettings[gameState.difficulty];
            gameState.zombiesToSpawn = Math.floor((config.baseZombiesPerNight + (gameState.day - 1) * config.zombieIncreasePerDay) * difficulty.zombieSpawnMultiplier);
            
            gameState.zombiesSpawned = 0;
            gameState.shopOpen = false;
            gameState.itemSpawnTimer = 0;
            gameState.bossSpawned = false;
            gameState.bossAlive = false;
            gameState.pistolCooldown = 0;
            gameState.shotgunCooldown = 0;
            gameState.laserRifleCooldown = 0;
            gameState.medkitCooldown = 0;
            gameState.grenadeCooldown = 0;
            gameState.hasLaserRifle = false;
            gameState.bossVomitCharging = false;
            gameState.bossVomitChargeTime = 0;
            
            // Aplicar multiplicador de pre√ßos da loja
            const shopPriceMultiplier = difficulty.shopPriceMultiplier;
            gameState.shopPrices = {
                ammo: Math.floor(12 * shopPriceMultiplier),
                shotgunAmmo: Math.floor(25 * shopPriceMultiplier),
                medkit: Math.floor(8 * shopPriceMultiplier),
                grenades: Math.floor(50 * shopPriceMultiplier),
                health: Math.floor(20 * shopPriceMultiplier),
                damage: Math.floor(15 * shopPriceMultiplier),
                speed: Math.floor(18 * shopPriceMultiplier),
                strengthPotion: Math.floor(120 * shopPriceMultiplier),
                luckPotion: Math.floor(200 * shopPriceMultiplier),
                ammoPotion: Math.floor(250 * shopPriceMultiplier),
                cooldownPotion: Math.floor(150 * shopPriceMultiplier)
            };
            
            gameState.activePotions = {
                strength: { active: false, daysLeft: 0 },
                luck: { active: false, daysLeft: 0 },
                infiniteAmmo: { active: false, daysLeft: 0 },
                cooldown: { active: false, daysLeft: 0 }
            };
            
            gameState.inventory = [
                { type: 'knife', ammo: null, maxAmmo: null },
                { type: 'pistol', ammo: 0, maxAmmo: 100 },
                { type: 'shotgun', ammo: 0, maxAmmo: 25 },
                { type: 'medkit', ammo: 0, maxAmmo: 10 },
                { type: 'grenade', ammo: 0, maxAmmo: 5 },
                { type: 'empty', ammo: null, maxAmmo: null } 
            ];
            gameState.selectedSlot = 0;
            
            // Resetar estat√≠sticas
            gameState.stats = {
                zombiesKilled: 0,
                coinsSpent: 0,
                ammoUsed: 0,
                medkitsUsed: 0,
                grenadesUsed: 0,
                bossesKilled: 0
            };
            
            updateInventoryUI();
            updateCoinUI();
            updateShopPricesUI();
            updateActivePotionsUI();
            
            gameState.obstacles = [];
            for (let i = 0; i < 20; i++) {
                gameState.obstacles.push({
                    x: Math.random() * (config.width - 100),
                    y: Math.random() * (config.height - 100),
                    width: 60 + Math.random() * 80,
                    height: 60 + Math.random() * 80,
                    type: ['building', 'car', 'tree'][Math.floor(Math.random() * 3)]
                });
            }
            
            gameLoop();
            dayNightCycle();
            itemSpawnLoop();
        }

        function gameLoop() {
            if (gameState.gameOver) return;
            
            ctx.clearRect(0, 0, config.width, config.height);
            
            drawMap();
            
            ctx.fillStyle = 'rgba(50, 50, 50, 1)';
            gameState.obstacles.forEach(obstacle => {
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });
            
            gameState.items.forEach(item => {
                let sprite;
                switch (item.type) {
                    case 'pistol': sprite = sprites.items.pistol; break;
                    case 'shotgun': sprite = sprites.items.shotgun; break;
                    case 'pistolAmmo': sprite = sprites.items.pistolAmmo; break;
                    case 'shotgunAmmo': sprite = sprites.items.shotgunAmmo; break;
                    case 'medkit': sprite = sprites.items.medkit; break;
                    case 'grenade': sprite = sprites.items.grenade; break;
                    case 'coin': sprite = sprites.items.coin; break;
                    case 'laserRifle': sprite = sprites.items.laserRifle; break;
                    case 'laserAmmo': 
                        sprite = document.createElement('canvas');
                        sprite.width = 30;
                        sprite.height = 30;
                        const ictx = sprite.getContext('2d');
                        ictx.fillStyle = '#00ff00';
                        ictx.beginPath();
                        ictx.arc(15, 15, 15, 0, Math.PI * 2);
                        ictx.fill();
                        ictx.font = '20px Arial';
                        ictx.textAlign = 'center';
                        ictx.textBaseline = 'middle';
                        ictx.fillStyle = '#fff';
                        ictx.fillText('üîã', 15, 15);
                        break;
                }
                
                const floatY = Math.sin(Date.now() / 500) * 3;
                
                ctx.drawImage(
                    sprite,
                    item.x,
                    item.y + floatY,
                    item.width,
                    item.height
                );
            });
            
            updateParticles();
            drawParticles();
            
            for (let i = gameState.laserChargeEffects.length - 1; i >= 0; i--) {
                const effect = gameState.laserChargeEffects[i];
                
                ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, effect.size, 0, Math.PI * 2);
                ctx.fill();
                
                effect.timer--;
                if (effect.timer <= 0) {
                    gameState.laserChargeEffects.splice(i, 1);
                }
            }
            
            for (let i = gameState.laserBeams.length - 1; i >= 0; i--) {
                const laser = gameState.laserBeams[i];
                
                const gradient = ctx.createLinearGradient(
                    laser.startX, laser.startY, 
                    laser.endX, laser.endY
                );
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0.9)');
                gradient.addColorStop(0.5, 'rgba(0, 255, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0.5)');
                
                ctx.strokeStyle = gradient;
                ctx.lineWidth = laser.width;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(laser.startX, laser.startY);
                ctx.lineTo(laser.endX, laser.endY);
                ctx.stroke();
                
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
                ctx.lineWidth = laser.width + 10;
                ctx.beginPath();
                ctx.moveTo(laser.startX, laser.startY);
                ctx.lineTo(laser.endX, laser.endY);
                ctx.stroke();
                
                // Aplicar dano continuamente enquanto o laser est√° ativo
                gameState.zombies.forEach(zombie => {
                    const zombieCenterX = zombie.x + zombie.width / 2;
                    const zombieCenterY = zombie.y + zombie.height / 2;
                    
                    if (pointToLineDistance(zombieCenterX, zombieCenterY, laser.startX, laser.startY, laser.endX, laser.endY) < 60) {
                        zombie.takeDamage(250); // 250 de dano por frame
                    }
                });
                
                laser.timer--;
                if (laser.timer <= 0) {
                    gameState.laserBeams.splice(i, 1);
                }
            }
            
            for (let i = gameState.bossProjectiles.length - 1; i >= 0; i--) {
                const projectile = gameState.bossProjectiles[i];
                projectile.update();
                
                ctx.fillStyle = 'rgba(255, 0, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, 10, 0, Math.PI * 2);
                ctx.fill();
                
                if (projectile.lifetime <= 0 ||
                    projectile.x < 0 || projectile.x > config.width ||
                    projectile.y < 0 || projectile.y > config.height) {
                    gameState.bossProjectiles.splice(i, 1);
                }
            }
            
            for (let i = gameState.bossVomits.length - 1; i >= 0; i--) {
                const vomit = gameState.bossVomits[i];
                
                ctx.fillStyle = 'rgba(255, 0, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(vomit.x, vomit.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                vomit.timer--;
                if (vomit.timer <= 0) {
                    gameState.bossVomits.splice(i, 1);
                }
            }
            
            for (let i = gameState.sniperBullets.length - 1; i >= 0; i--) {
                const bullet = gameState.sniperBullets[i];
                bullet.update();
                bullet.draw();
                
                if (bullet.lifetime <= 0 ||
                    bullet.x < 0 || bullet.x > config.width ||
                    bullet.y < 0 || bullet.y > config.height) {
                    gameState.sniperBullets.splice(i, 1);
                }
            }
            
            for (let i = gameState.grenades.length - 1; i >= 0; i--) {
                const grenade = gameState.grenades[i];
                
                const flashIntensity = grenade.flashTimer > 0 ? 
                    (grenade.flashTimer % 10 < 5 ? 1 : 0.5) : 1;
                
                ctx.fillStyle = `rgba(255, 0, 0, ${flashIntensity})`;
                ctx.beginPath();
                ctx.arc(grenade.x, grenade.y, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = `rgba(255, 165, 0, ${flashIntensity})`;
                ctx.beginPath();
                ctx.arc(grenade.x, grenade.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                if (!grenade.exploded && !grenade.stuckZombie) {
                    for (const zombie of gameState.zombies) {
                        if (
                            grenade.x > zombie.x && grenade.x < zombie.x + zombie.width &&
                            grenade.y > zombie.y && grenade.y < zombie.y + zombie.height
                        ) {
                            grenade.stuckZombie = zombie;
                            grenade.exploded = true;
                            grenade.flashTimer = 0;
                            break;
                        }
                    }
                }
                
                if (grenade.stuckZombie) {
                    grenade.x = grenade.stuckZombie.x + grenade.stuckZombie.width / 2;
                    grenade.y = grenade.stuckZombie.y + grenade.stuckZombie.height / 2;
                }
                
                if (!grenade.exploded && !grenade.stuckZombie) {
                    grenade.x += grenade.vx;
                    grenade.y += grenade.vy;
                    grenade.distanceTraveled += Math.sqrt(grenade.vx * grenade.vx + grenade.vy * grenade.vy);
                    
                    if (grenade.distanceTraveled >= grenade.maxDistance) {
                        grenade.exploded = true;
                        grenade.flashTimer = 90;
                    }
                } else if (grenade.exploded) {
                    grenade.flashTimer--;
                    
                    if (grenade.flashTimer <= 0) {
                        gameState.explosions.push({
                            x: grenade.x,
                            y: grenade.y,
                            radius: 0,
                            maxRadius: 70,
                            timer: 30
                        });
                        
                        gameState.zombies.forEach(zombie => {
                            const dx = zombie.x + zombie.width/2 - grenade.x;
                            const dy = zombie.y + zombie.height/2 - grenade.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 500) {
                                const damage = 300 * (1 - distance/250);
                                zombie.takeDamage(damage);
                            }
                        });
                        
                        gameState.grenades.splice(i, 1);
                    }
                }
            }
            
            for (let i = gameState.explosions.length - 1; i >= 0; i--) {
                const explosion = gameState.explosions[i];
                
                const gradient = ctx.createRadialGradient(
                    explosion.x, explosion.y, 0,
                    explosion.x, explosion.y, explosion.radius
                );
                gradient.addColorStop(0, 'rgba(255, 100, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fill();
                
                explosion.radius += explosion.maxRadius / 6;
                explosion.timer--;
                
                if (explosion.timer <= 0) {
                    gameState.explosions.splice(i, 1);
                }
            }
            
            for (let i = gameState.deathEffects.length - 1; i >= 0; i--) {
                const effect = gameState.deathEffects[i];
                
                ctx.globalAlpha = effect.alpha;
                ctx.fillStyle = effect.color;
                
                if (effect.type === 'blood') {
                    for (let j = 0; j < effect.particles; j++) {
                        const angle = (j / effect.particles) * Math.PI * 2;
                        const distance = effect.radius * (effect.timer / effect.maxTimer);
                        const x = effect.x + Math.cos(angle) * distance;
                        const y = effect.y + Math.sin(angle) * distance;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (effect.type === 'boss') {
                    ctx.beginPath();
                    ctx.arc(effect.x, effect.y, effect.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    for (let j = 0; j < 8; j++) {
                        const angle = (j / 8) * Math.PI * 2;
                        const x = effect.x + Math.cos(angle) * effect.radius * 1.5;
                        const y = effect.y + Math.sin(angle) * effect.radius * 1.5;
                        
                        ctx.beginPath();
                        ctx.moveTo(effect.x, effect.y);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                    }
                }
                
                ctx.globalAlpha = 1;
                
                effect.timer--;
                if (effect.timer <= 0) {
                    gameState.deathEffects.splice(i, 1);
                }
            }
            
            gameState.acidBullets.forEach((acid, index) => {
                acid.update();
                acid.draw();
                
                if (acid.lifetime <= 0) {
                    gameState.acidBullets.splice(index, 1);
                }
            });
            
            gameState.player.update();
            gameState.player.draw();
            
            gameState.zombies.forEach(zombie => {
                zombie.update();
                zombie.draw();
            });
            
            if (gameState.isNight && gameState.zombiesSpawned < gameState.zombiesToSpawn && !gameState.bossAlive) {
                spawnZombie();
            }
            
            if (gameState.isNight && gameState.day % 5 === 0 && !gameState.bossSpawned && gameState.zombiesSpawned >= Math.floor(gameState.zombiesToSpawn * 0.7)) {
                spawnBoss();
                gameState.bossSpawned = true;
                gameState.bossAlive = true;
            }
            
            if (!gameState.isNight && gameState.zombies.length > 0) {
                gameState.zombies = [];
                gameState.zombiesSpawned = 0;
                gameState.bossSpawned = false;
                gameState.bossAlive = false;
            }
            
            gameState.bullets.forEach((bullet, index) => {
                bullet.update();
                bullet.draw();
                
                if (
                    bullet.lifetime <= 0 ||
                    bullet.x < 0 || bullet.x > config.width ||
                    bullet.y < 0 || bullet.y > config.height
                ) {
                    gameState.bullets.splice(index, 1);
                }
            });
            
            if (gameState.pistolCooldown > 0) {
                gameState.pistolCooldown--;
            }
            if (gameState.shotgunCooldown > 0) {
                gameState.shotgunCooldown--;
            }
            if (gameState.attackCooldown > 0) {
                gameState.attackCooldown--;
            }
            if (gameState.laserRifleCooldown > 0) {
                gameState.laserRifleCooldown--;
            }
            if (gameState.medkitCooldown > 0) {
                gameState.medkitCooldown--;
            }
            if (gameState.grenadeCooldown > 0) {
                gameState.grenadeCooldown--;
            }
            
            document.getElementById('zombieCount').textContent = gameState.zombies.length;
            document.getElementById('day').textContent = gameState.day;
            document.getElementById('dayTime').textContent = gameState.isNight ? 'üåô NOITE' : '‚òÄÔ∏è DIA';
            document.getElementById('dayTime').style.color = gameState.isNight ? '#ff5555' : '#ffcc55';
            
            if (gameState.bossAlive) {
                document.getElementById('timeLeft').style.display = 'none';
                document.getElementById('bossMessage').style.display = 'block';
            } else {
                document.getElementById('timeLeft').style.display = 'block';
                document.getElementById('bossMessage').style.display = 'none';
                const timeLeft = gameState.isNight 
                    ? Math.ceil((config.nightDuration - gameState.gameTime) / 1000)
                    : Math.ceil((config.dayDuration - gameState.gameTime) / 1000);
                document.getElementById('timeLeft').textContent = `TEMPO: ${timeLeft}s`;
            }
            
            updateCooldownIndicators();
            
            requestAnimationFrame(gameLoop);
        }

        function updateCooldownIndicators() {
            document.querySelectorAll('.cooldown-indicator').forEach(el => el.remove());
            
            if (gameState.pistolCooldown > 0) {
                const slot = document.querySelectorAll('.inventory-slot')[1];
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-indicator';
                indicator.textContent = (gameState.pistolCooldown / 60).toFixed(1);
                slot.appendChild(indicator);
            }
            
            if (gameState.shotgunCooldown > 0) {
                const slot = document.querySelectorAll('.inventory-slot')[2];
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-indicator';
                indicator.textContent = (gameState.shotgunCooldown / 60).toFixed(1);
                slot.appendChild(indicator);
            }
            
            if (gameState.laserRifleCooldown > 0) {
                const slot = document.querySelectorAll('.inventory-slot')[5];
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-indicator';
                indicator.textContent = (gameState.laserRifleCooldown / 60).toFixed(1);
                slot.appendChild(indicator);
            }
            
            if (gameState.medkitCooldown > 0) {
                const slot = document.querySelectorAll('.inventory-slot')[3];
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-indicator';
                indicator.textContent = (gameState.medkitCooldown / 60).toFixed(1);
                slot.appendChild(indicator);
            }
            
            if (gameState.grenadeCooldown > 0) {
                const slot = document.querySelectorAll('.inventory-slot')[4];
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-indicator';
                indicator.textContent = (gameState.grenadeCooldown / 60).toFixed(1);
                slot.appendChild(indicator);
            }
        }

        function spawnZombie() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch (side) {
                case 0: x = -50; y = Math.random() * config.height; break;
                case 1: x = config.width + 50; y = Math.random() * config.height; break;
                case 2: x = Math.random() * config.width; y = -50; break;
                case 3: x = Math.random() * config.width; y = config.height + 50; break;
            }
            
            let zombieTypes = ['normal', 'normal', 'normal', 'runner', 'brute', 'crawler', 'toxic'];
            let weights = [0.5, 0.5, 0.5, 0.3, 0.2, 0.3, 0.2];
            
            if (gameState.day >= 3) {
                zombieTypes.push('tank');
                weights.push(0.1);
            }
            if (gameState.day >= 5) {
                zombieTypes.push('fast');
                weights.push(0.15);
            }
            if (gameState.day >= 7) {
                zombieTypes.push('spitter');
                weights.push(0.15);
                zombieTypes.push('sniper');
                weights.push(0.1);
            }
            
            const sum = weights.reduce((a, b) => a + b, 0);
            weights = weights.map(w => w / sum);
            
            let selectedType = 'normal';
            let roll = Math.random();
            
            for (let i = 0; i < zombieTypes.length; i++) {
                if (roll < weights[i]) {
                    selectedType = zombieTypes[i];
                    break;
                }
                roll -= weights[i];
            }
            
            gameState.zombies.push(new Zombie(x, y, selectedType));
            gameState.zombiesSpawned++;
        }

        function spawnBoss() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch (side) {
                case 0: x = -80; y = Math.random() * config.height; break;
                case 1: x = config.width + 80; y = Math.random() * config.height; break;
                case 2: x = Math.random() * config.width; y = -80; break;
                case 3: x = Math.random() * config.width; y = config.height + 80; break;
            }
            
            gameState.zombies.push(new Zombie(x, y, 'boss'));
            gameState.zombiesSpawned++;
            gameState.zombiesToSpawn = Math.floor(gameState.zombiesToSpawn * 0.7);
        }

        function endNight() {
            gameState.isNight = false;
            gameState.gameTime = 0;
            gameState.day++;
            
            // Aplicar configura√ß√µes de dificuldade
            const difficulty = difficultySettings[gameState.difficulty];
            gameState.zombiesToSpawn = Math.floor((config.baseZombiesPerNight + (gameState.day - 1) * config.zombieIncreasePerDay) * difficulty.zombieSpawnMultiplier);
            
            gameState.zombiesSpawned = 0;
            document.getElementById('nightOverlay').style.display = 'none';
            
            updateActivePotions();
            
            openShop();
        }

        function updateActivePotions() {
            if (gameState.activePotions.strength.active) {
                gameState.activePotions.strength.daysLeft--;
                if (gameState.activePotions.strength.daysLeft <= 0) {
                    gameState.activePotions.strength.active = false;
                    gameState.player.removeStrengthPotion();
                }
            }
            
            if (gameState.activePotions.luck.active) {
                gameState.activePotions.luck.daysLeft--;
                if (gameState.activePotions.luck.daysLeft <= 0) {
                    gameState.activePotions.luck.active = false;
                }
            }
            
            if (gameState.activePotions.infiniteAmmo.active) {
                gameState.activePotions.infiniteAmmo.daysLeft--;
                if (gameState.activePotions.infiniteAmmo.daysLeft <= 0) {
                    gameState.activePotions.infiniteAmmo.active = false;
                }
            }
            
            if (gameState.activePotions.cooldown.active) {
                gameState.activePotions.cooldown.daysLeft--;
                if (gameState.activePotions.cooldown.daysLeft <= 0) {
                    gameState.activePotions.cooldown.active = false;
                    gameState.player.removeCooldownPotion();
                }
            }
            
            updateActivePotionsUI();
            updateShopButtons();
        }

        function dayNightCycle() {
            if (gameState.gameOver) return;
            
            if (!(gameState.isNight && gameState.bossAlive)) {
                gameState.gameTime += 100;
            }
            
            if (gameState.isNight) {
                if (gameState.gameTime >= config.nightDuration && !gameState.bossAlive) {
                    gameState.isNight = false;
                    gameState.gameTime = 0;
                    gameState.day++;
                    
                    // Aplicar configura√ß√µes de dificuldade
                    const difficulty = difficultySettings[gameState.difficulty];
                    gameState.zombiesToSpawn = Math.floor((config.baseZombiesPerNight + (gameState.day - 1) * config.zombieIncreasePerDay) * difficulty.zombieSpawnMultiplier);
                    
                    gameState.zombiesSpawned = 0;
                    document.getElementById('nightOverlay').style.display = 'none';
                    
                    updateActivePotions();
                    
                    openShop();
                }
            } else {
                if (gameState.gameTime >= config.dayDuration) {
                    gameState.isNight = true;
                    gameState.gameTime = 0;
                    document.getElementById('nightOverlay').style.display = 'block';
                    
                    if (gameState.shopOpen) {
                        closeShop();
                    }
                }
            }
            
            setTimeout(dayNightCycle, 100);
        }

        function itemSpawnLoop() {
            if (gameState.gameOver) return;
            
            gameState.itemSpawnTimer += 100;
            
            if (gameState.itemSpawnTimer >= config.itemSpawnInterval) {
                gameState.itemSpawnTimer = 0;
                
                if (Math.random() < config.itemSpawnChance) {
                    const items = ['pistolAmmo', 'medkit'];
                    const selectedItem = items[Math.floor(Math.random() * items.length)];
                    
                    gameState.items.push({
                        type: selectedItem,
                        x: Math.random() * (config.width - 50),
                        y: Math.random() * (config.height - 50),
                        width: 20,
                        height: 20
                    });
                }
            }
            
            setTimeout(itemSpawnLoop, 100);
        }

        function openShop() {
            if (gameState.isNight) return;
            gameState.shopOpen = true;
            document.getElementById('shop').style.display = 'block';
            updateShopButtons();
        }
        
        function closeShop() {
            gameState.shopOpen = false;
            document.getElementById('shop').style.display = 'none';
        }
        
        function updateShopPricesUI() {
            document.getElementById('buyAmmo').textContent = `ü™ô${Math.floor(gameState.shopPrices.ammo)} COMPRAR`;
            document.getElementById('buyShotgunAmmo').textContent = `ü™ô${Math.floor(gameState.shopPrices.shotgunAmmo)} COMPRAR`;
            document.getElementById('buyMedkit').textContent = `ü™ô${Math.floor(gameState.shopPrices.medkit)} COMPRAR`;
            document.getElementById('buyGrenades').textContent = `ü™ô${Math.floor(gameState.shopPrices.grenades)} COMPRAR`;
            document.getElementById('buyHealth').textContent = `ü™ô${Math.floor(gameState.shopPrices.health)} COMPRAR`;
            document.getElementById('buyDamage').textContent = `ü™ô${Math.floor(gameState.shopPrices.damage)} COMPRAR`;
            document.getElementById('buySpeed').textContent = `ü™ô${Math.floor(gameState.shopPrices.speed)} COMPRAR`;
            document.getElementById('buyStrengthPotion').textContent = `ü™ô${Math.floor(gameState.shopPrices.strengthPotion)} COMPRAR`;
            document.getElementById('buyLuckPotion').textContent = `ü™ô${Math.floor(gameState.shopPrices.luckPotion)} COMPRAR`;
            document.getElementById('buyAmmoPotion').textContent = `ü™ô${Math.floor(gameState.shopPrices.ammoPotion)} COMPRAR`;
            document.getElementById('buyCooldownPotion').textContent = `ü™ô${Math.floor(gameState.shopPrices.cooldownPotion)} COMPRAR`;
        }
        
        function updateShopButtons() {
            document.getElementById('buyStrengthPotion').disabled = gameState.activePotions.strength.active;
            document.getElementById('buyLuckPotion').disabled = gameState.activePotions.luck.active;
            document.getElementById('buyAmmoPotion').disabled = gameState.activePotions.infiniteAmmo.active;
            document.getElementById('buyCooldownPotion').disabled = gameState.activePotions.cooldown.active;
            
            document.getElementById('buyAmmo').disabled = gameState.coins < gameState.shopPrices.ammo;
            document.getElementById('buyShotgunAmmo').disabled = gameState.coins < gameState.shopPrices.shotgunAmmo;
            document.getElementById('buyMedkit').disabled = gameState.coins < gameState.shopPrices.medkit;
            document.getElementById('buyGrenades').disabled = gameState.coins < gameState.shopPrices.grenades;
            document.getElementById('buyHealth').disabled = gameState.coins < gameState.shopPrices.health;
            document.getElementById('buyDamage').disabled = gameState.coins < gameState.shopPrices.damage;
            document.getElementById('buySpeed').disabled = gameState.coins < gameState.shopPrices.speed;
            document.getElementById('buyStrengthPotion').disabled = gameState.coins < gameState.shopPrices.strengthPotion || gameState.activePotions.strength.active;
            document.getElementById('buyLuckPotion').disabled = gameState.coins < gameState.shopPrices.luckPotion || gameState.activePotions.luck.active;
            document.getElementById('buyAmmoPotion').disabled = gameState.coins < gameState.shopPrices.ammoPotion || gameState.activePotions.infiniteAmmo.active;
            document.getElementById('buyCooldownPotion').disabled = gameState.coins < gameState.shopPrices.cooldownPotion || gameState.activePotions.cooldown.active;
        }
        
        function buyAmmo() {
            if (gameState.coins >= gameState.shopPrices.ammo) {
                for (let i = 0; i < gameState.inventory.length; i++) {
                    if (gameState.inventory[i].type === 'pistol') {
                        const maxAmmo = gameState.inventory[i].maxAmmo;
                        const currentAmmo = gameState.inventory[i].ammo;
                        const ammoToAdd = Math.min(12, maxAmmo - currentAmmo);
                        
                        gameState.inventory[i].ammo += ammoToAdd;
                        gameState.coins -= gameState.shopPrices.ammo;
                        gameState.stats.coinsSpent += gameState.shopPrices.ammo;
                        updateInventoryUI();
                        updateCoinUI();
                        updateShopButtons();
                        break;
                    }
                }
            }
        }
        
        function buyShotgunAmmo() {
            if (gameState.coins >= gameState.shopPrices.shotgunAmmo) {
                for (let i = 0; i < gameState.inventory.length; i++) {
                    if (gameState.inventory[i].type === 'shotgun') {
                        const maxAmmo = gameState.inventory[i].maxAmmo;
                        const currentAmmo = gameState.inventory[i].ammo;
                        const ammoToAdd = Math.min(5, maxAmmo - currentAmmo);
                        
                        gameState.inventory[i].ammo += ammoToAdd;
                        gameState.coins -= gameState.shopPrices.shotgunAmmo;
                        gameState.stats.coinsSpent += gameState.shopPrices.shotgunAmmo;
                        updateInventoryUI();
                        updateCoinUI();
                        updateShopButtons();
                        break;
                    }
                }
            }
        }
        
        function buyHealth() {
            if (gameState.coins >= gameState.shopPrices.health) {
                gameState.player.increaseMaxHealth(10);
                gameState.coins -= gameState.shopPrices.health;
                gameState.stats.coinsSpent += gameState.shopPrices.health;
                gameState.shopPrices.health = Math.floor(gameState.shopPrices.health * 1.2);
                updateCoinUI();
                updateShopPricesUI();
                updateShopButtons();
            }
        }
        
        function buyDamage() {
            if (gameState.coins >= gameState.shopPrices.damage) {
                gameState.player.increaseDamage(0.1);
                gameState.coins -= gameState.shopPrices.damage;
                gameState.stats.coinsSpent += gameState.shopPrices.damage;
                gameState.shopPrices.damage = Math.floor(gameState.shopPrices.damage * 1.2);
                updateCoinUI();
                updateShopPricesUI();
                updateShopButtons();
            }
        }
        
        function buySpeed() {
            if (gameState.coins >= gameState.shopPrices.speed) {
                gameState.player.increaseMaxStamina(10);
                gameState.coins -= gameState.shopPrices.speed;
                gameState.stats.coinsSpent += gameState.shopPrices.speed;
                gameState.shopPrices.speed = Math.floor(gameState.shopPrices.speed * 1.2);
                updateCoinUI();
                updateShopPricesUI();
                updateShopButtons();
            }
        }
        
        function buyMedkit() {
            if (gameState.coins >= gameState.shopPrices.medkit) {
                for (let i = 0; i < gameState.inventory.length; i++) {
                    if (gameState.inventory[i].type === 'medkit') {
                        const maxAmmo = gameState.inventory[i].maxAmmo;
                        const currentAmmo = gameState.inventory[i].ammo;
                        
                        if (currentAmmo < maxAmmo) {
                            gameState.inventory[i].ammo += 1;
                            gameState.coins -= gameState.shopPrices.medkit;
                            gameState.stats.coinsSpent += gameState.shopPrices.medkit;
                            updateInventoryUI();
                            updateCoinUI();
                            updateShopButtons();
                        }
                        break;
                    }
                }
            }
        }
        
        function buyGrenades() {
            if (gameState.coins >= gameState.shopPrices.grenades) {
                for (let i = 0; i < gameState.inventory.length; i++) {
                    if (gameState.inventory[i].type === 'grenade') {
                        const maxAmmo = gameState.inventory[i].maxAmmo;
                        const currentAmmo = gameState.inventory[i].ammo;
                        
                        if (currentAmmo < maxAmmo) {
                            gameState.inventory[i].ammo += 2;
                            gameState.coins -= gameState.shopPrices.grenades;
                            gameState.stats.coinsSpent += gameState.shopPrices.grenades;
                            updateInventoryUI();
                            updateCoinUI();
                            updateShopButtons();
                        }
                        break;
                    }
                }
            }
        }
        
        function buyStrengthPotion() {
            if (gameState.coins >= gameState.shopPrices.strengthPotion && !gameState.activePotions.strength.active) {
                gameState.coins -= gameState.shopPrices.strengthPotion;
                gameState.stats.coinsSpent += gameState.shopPrices.strengthPotion;
                gameState.activePotions.strength.active = true;
                gameState.activePotions.strength.daysLeft = 3;
                gameState.player.applyStrengthPotion();
                updateCoinUI();
                updateActivePotionsUI();
                updateShopButtons();
            }
        }
        
        function buyLuckPotion() {
            if (gameState.coins >= gameState.shopPrices.luckPotion && !gameState.activePotions.luck.active) {
                gameState.coins -= gameState.shopPrices.luckPotion;
                gameState.stats.coinsSpent += gameState.shopPrices.luckPotion;
                gameState.activePotions.luck.active = true;
                gameState.activePotions.luck.daysLeft = 1;
                updateCoinUI();
                updateActivePotionsUI();
                updateShopButtons();
            }
        }
        
        function buyAmmoPotion() {
            if (gameState.coins >= gameState.shopPrices.ammoPotion && !gameState.activePotions.infiniteAmmo.active) {
                gameState.coins -= gameState.shopPrices.ammoPotion;
                gameState.stats.coinsSpent += gameState.shopPrices.ammoPotion;
                gameState.activePotions.infiniteAmmo.active = true;
                gameState.activePotions.infiniteAmmo.daysLeft = 2;
                updateCoinUI();
                updateActivePotionsUI();
                updateShopButtons();
            }
        }
        
        function buyCooldownPotion() {
            if (gameState.coins >= gameState.shopPrices.cooldownPotion && !gameState.activePotions.cooldown.active) {
                gameState.coins -= gameState.shopPrices.cooldownPotion;
                gameState.stats.coinsSpent += gameState.shopPrices.cooldownPotion;
                gameState.activePotions.cooldown.active = true;
                gameState.activePotions.cooldown.daysLeft = 2;
                gameState.player.applyCooldownPotion();
                updateCoinUI();
                updateActivePotionsUI();
                updateShopButtons();
            }
        }

        function updateInventoryUI() {
            document.querySelectorAll('.inventory-slot').forEach((slot, index) => {
                if (gameState.inventory[index].type === 'laserRifle' && !gameState.hasLaserRifle) {
                    slot.innerHTML = '‚ùì<div class="slot-ammo">?</div>';
                    return;
                }
                
                slot.innerHTML = getWeaponIcon(gameState.inventory[index].type);
                
                if (gameState.inventory[index].ammo !== null) {
                    const maxAmmo = gameState.inventory[index].maxAmmo;
                    if (maxAmmo !== null) {
                        slot.innerHTML += `<div class="slot-ammo">${gameState.inventory[index].ammo}/${maxAmmo}</div>`;
                    } else {
                        slot.innerHTML += `<div class="slot-ammo">${gameState.inventory[index].ammo}</div>`;
                    }
                } else {
                    slot.innerHTML += '<div class="slot-ammo">-</div>';
                }
                
                if (index === gameState.selectedSlot) {
                    slot.classList.add('active');
                } else {
                    slot.classList.remove('active');
                }
            });
        }
        
        function updateCoinUI() {
            document.getElementById('coinCount').textContent = gameState.coins;
        }
        
        function updateActivePotionsUI() {
            const container = document.getElementById('active-potions');
            container.innerHTML = '';
            
            if (gameState.activePotions.strength.active) {
                const indicator = document.createElement('div');
                indicator.className = 'potion-indicator';
                indicator.style.background = '#ff0000';
                indicator.innerHTML = '<div class="days-left">' + gameState.activePotions.strength.daysLeft + ' dias</div>';
                container.appendChild(indicator);
            }
            
            if (gameState.activePotions.luck.active) {
                const indicator = document.createElement('div');
                indicator.className = 'potion-indicator';
                indicator.style.background = '#ffcc00';
                indicator.innerHTML = '<div class="days-left">' + gameState.activePotions.luck.daysLeft + ' dias</div>';
                container.appendChild(indicator);
            }
            
            if (gameState.activePotions.infiniteAmmo.active) {
                const indicator = document.createElement('div');
                indicator.className = 'potion-indicator';
                indicator.style.background = '#aaaaaa';
                indicator.innerHTML = '<div class="days-left">' + gameState.activePotions.infiniteAmmo.daysLeft + ' dias</div>';
                container.appendChild(indicator);
            }
            
            if (gameState.activePotions.cooldown.active) {
                const indicator = document.createElement('div');
                indicator.className = 'potion-indicator';
                indicator.style.background = '#00aaff';
                indicator.innerHTML = '<div class="days-left">' + gameState.activePotions.cooldown.daysLeft + ' dias</div>';
                container.appendChild(indicator);
            }
        }
        
        function getWeaponIcon(type) {
            switch (type) {
                case 'knife': return 'üî™';
                case 'pistol': return 'üî´';
                case 'shotgun': return 'üí•';
                case 'medkit': return 'ü©π';
                case 'grenade': return 'üß®';
                case 'pistolAmmo': return 'üîπ';
                case 'shotgunAmmo': return 'üî∏';
                case 'laserRifle': return 'üîã';
                case 'laserAmmo': return 'üîã';
                case 'empty': return '‚ùì';
                default: return '‚ùì';
            }
        }
        
        function getMaxAmmoForItem(type) {
            switch (type) {
                case 'pistol': return 100;
                case 'shotgun': return 25;
                case 'medkit': return 10;
                case 'grenade': return 6;
                default: return null;
            }
        }

        window.addEventListener('keydown', (e) => {
            const player = gameState.player;
            
            switch (e.key) {
                case 'w': player.direction.y = -1; break;
                case 's': player.direction.y = 1; break;
                case 'a': player.direction.x = -1; break;
                case 'd': player.direction.x = 1; break;
                case 'Shift': player.isRunning = true; break;
                case '1': gameState.selectedSlot = 0; updateInventoryUI(); break;
                case '2': gameState.selectedSlot = 1; updateInventoryUI(); break;
                case '3': gameState.selectedSlot = 2; updateInventoryUI(); break;
                case '4': gameState.selectedSlot = 3; updateInventoryUI(); break;
                case '5': gameState.selectedSlot = 4; updateInventoryUI(); break;
                case '6': gameState.selectedSlot = 5; updateInventoryUI(); break;
                case 'e': 
                    if (!gameState.isNight && !gameState.shopOpen) {
                        openShop();
                    } else if (gameState.shopOpen) {
                        closeShop();
                    }
                    break;
            }
        });

        window.addEventListener('keyup', (e) => {
            const player = gameState.player;
            
            switch (e.key) {
                case 'w': if (player.direction.y === -1) player.direction.y = 0; break;
                case 's': if (player.direction.y === 1) player.direction.y = 0; break;
                case 'a': if (player.direction.x === -1) player.direction.x = 0; break;
                case 'd': if (player.direction.x === 1) player.direction.x = 0; break;
                case 'Shift': player.isRunning = false; break;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            gameState.player.angle = Math.atan2(
                mouseY - (gameState.player.y + gameState.player.height / 2),
                mouseX - (gameState.player.x + gameState.player.width / 2)
            );
        });

        canvas.addEventListener('click', (e) => {
            if (gameState.shopOpen) return;
            
            const weapon = gameState.inventory[gameState.selectedSlot];
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (weapon.type === 'knife') {
                gameState.player.meleeAttack();
            } else if (weapon.type === 'pistol' && weapon.ammo > 0 && gameState.pistolCooldown <= 0) {
                const player = gameState.player;
                const barrelX = player.x + player.width / 2 + Math.cos(player.angle) * 35;
                const barrelY = player.y + player.height / 2 + Math.sin(player.angle) * 35;
                
                gameState.bullets.push(new Bullet(
                    barrelX,
                    barrelY,
                    player.angle,
                    'pistol'
                ));
                
                if (!gameState.activePotions.infiniteAmmo.active) {
                    weapon.ammo--;
                    gameState.stats.ammoUsed++;
                }
                gameState.pistolCooldown = gameState.activePotions.cooldown.active ? 
                    gameState.potionCooldowns.pistol : gameState.baseCooldowns.pistol;
                updateInventoryUI();
            } else if (weapon.type === 'shotgun' && weapon.ammo > 0 && gameState.shotgunCooldown <= 0) {
                const player = gameState.player;
                const barrelX = player.x + player.width / 2 + Math.cos(player.angle) * 40;
                const barrelY = player.y + player.height / 2 + Math.sin(player.angle) * 40;
                
                for (let i = 0; i < 5; i++) {
                    const spread = (i - 2) * Math.PI / 24;
                    gameState.bullets.push(new Bullet(
                        barrelX,
                        barrelY,
                        player.angle + spread,
                        'shotgun'
                    ));
                }
                
                if (!gameState.activePotions.infiniteAmmo.active) {
                    weapon.ammo--;
                    gameState.stats.ammoUsed++;
                }
                gameState.shotgunCooldown = gameState.activePotions.cooldown.active ? 
                    gameState.potionCooldowns.shotgun : gameState.baseCooldowns.shotgun;
                updateInventoryUI();
            } else if (weapon.type === 'medkit') {
                gameState.player.useMedkit();
            } else if (weapon.type === 'grenade') {
                gameState.player.throwGrenade(mouseX, mouseY);
            } else if (weapon.type === 'laserRifle' && weapon.ammo > 0) {
                if (gameState.player.startLaserRifleCharge()) {
                    weapon.ammo--;
                    gameState.stats.ammoUsed++;
                    updateInventoryUI();
                }
            }
        });

        function normalizeAngle(angle) {
            while (angle > Math.PI) angle -= Math.PI * 2;
            while (angle < -Math.PI) angle += Math.PI * 2;
            return angle;
        }

        document.getElementById('easyButton').addEventListener('click', () => {
            gameState.difficulty = 'easy';
            document.getElementById('startScreen').style.display = 'none';
            initGame();
        });

        document.getElementById('normalButton').addEventListener('click', () => {
            gameState.difficulty = 'normal';
            document.getElementById('startScreen').style.display = 'none';
            initGame();
        });

        document.getElementById('hardButton').addEventListener('click', () => {
            gameState.difficulty = 'hard';
            document.getElementById('startScreen').style.display = 'none';
            initGame();
        });

        document.getElementById('restartButton').addEventListener('click', () => {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        });

        document.getElementById('buyAmmo').addEventListener('click', buyAmmo);
        document.getElementById('buyShotgunAmmo').addEventListener('click', buyShotgunAmmo);
        document.getElementById('buyHealth').addEventListener('click', buyHealth);
        document.getElementById('buyDamage').addEventListener('click', buyDamage);
        document.getElementById('buySpeed').addEventListener('click', buySpeed);
        document.getElementById('buyMedkit').addEventListener('click', buyMedkit);
        document.getElementById('buyGrenades').addEventListener('click', buyGrenades);
        document.getElementById('buyStrengthPotion').addEventListener('click', buyStrengthPotion);
        document.getElementById('buyLuckPotion').addEventListener('click', buyLuckPotion);
        document.getElementById('buyAmmoPotion').addEventListener('click', buyAmmoPotion);
        document.getElementById('buyCooldownPotion').addEventListener('click', buyCooldownPotion);
        document.getElementById('closeShop').addEventListener('click', closeShop);

        document.getElementById('bloodOverlay').style.background = 
            'radial-gradient(circle, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0) 70%)';

        const sprites = {
            player: createPlayerSprite(),
            zombies: {
                normal: createZombieSprite('#8fbb6b'),
                runner: createZombieSprite('#c78f6b'),
                brute: createZombieSprite('#6b8fbb'),
                crawler: createZombieSprite('#6b8f6b'),
                toxic: createZombieSprite('#8fbb8f'),
                tank: createZombieSprite('#ff8800'),
                fast: createZombieSprite('#aa55ff'),
                spitter: createZombieSprite('#55aaff'),
                sniper: createSniperZombieSprite(),
                boss: createBossSprite()
            },
            items: {
                pistol: createItemSprite('üî´', '#ff5555'),
                shotgun: createItemSprite('üí•', '#ffaa00'),
                pistolAmmo: createItemSprite('üîπ', '#55aaff'),
                shotgunAmmo: createItemSprite('üî∏', '#ffaa55'),
                medkit: createItemSprite('ü©π', '#55ff55'),
                grenade: createItemSprite('üß®', '#ff55ff'),
                coin: createItemSprite('ü™ô', '#ffcc00'),
                laserRifle: createItemSprite('üîã', '#00ff00'),
                laserAmmo: null
            },
            weapons: {
                pistol: createWeaponSprite('#777', '#ffcc55'),
                shotgun: createShotgunSprite(),
                knife: createKnifeSprite(),
                laserRifle: createLaserRifleSprite(),
                medkit: createMedkitSprite(),
                grenade: createGrenadeSprite()
            },
            terrain: {
                grass: createTerrainSprite('#3a5c3a'),
                road: createTerrainSprite('#555555'),
                water: createTerrainSprite('#3a5c8f'),
                building: createTerrainSprite('#8f3a3a')
            }
        };

        class Zombie {
            constructor(x, y, type = 'normal') {
                this.x = x;
                this.y = y;
                this.width = type === 'boss' ? 120 : 40;
                this.height = type === 'boss' ? 120 : 40;
                this.type = type;
                
                // Aplicar multiplicador de vida baseado na dificuldade
                const difficulty = difficultySettings[gameState.difficulty];
                this.health = this.getMaxHealth() * difficulty.zombieHealthMultiplier;
                
                this.speed = this.getSpeed();
                this.detectionRange = this.getDetectionRange();
                this.attackCooldown = 0;
                this.damage = this.getDamage();
                this.color = this.getColor();
                this.randomAngle = Math.random() * Math.PI * 2;
                this.lastSoundTime = 0;
                
                // Aplicar multiplicador de moedas baseado na dificuldade
                this.coinValue = Math.floor(this.getCoinValue() * difficulty.coinMultiplier);
                
                this.lastAcidShot = 0;
                this.specialAbilityCooldown = 0;
                this.lastBossAttack = 0;
                this.lastSniperShot = 0;
                this.laserDamageTimer = 0;
                this.isSniper = type === 'sniper';
                this.retreating = false;
            }
            
            getMaxHealth() {
                switch (this.type) {
                    case 'runner': return 80;
                    case 'brute': return 150;
                    case 'crawler': return 60;
                    case 'toxic': return 90;
                    case 'tank': return 250;
                    case 'fast': return 80;
                    case 'spitter': return 100;
                    case 'sniper': return 80;
                    case 'boss': return 500 + (gameState.day * 100);
                    default: return 100;
                }
            }
            
            getSpeed() {
                const nightBonus = gameState.isNight ? 1.2 : 1;
                switch (this.type) {
                    case 'runner': return 2.5 * nightBonus;
                    case 'brute': return 1.2 * nightBonus;
                    case 'crawler': return 1.5 * nightBonus;
                    case 'toxic': return 1.8 * nightBonus;
                    case 'tank': return 1.0 * nightBonus;
                    case 'fast': return 3.0 * nightBonus;
                    case 'spitter': return 1.8 * nightBonus;
                    case 'sniper': return 2.0 * nightBonus;
                    case 'boss': return 1.5 * nightBonus;
                    default: return 1.8 * nightBonus;
                }
            }
            
            getDetectionRange() {
                switch (this.type) {
                    case 'runner': return 250;
                    case 'brute': return 350;
                    case 'crawler': return 200;
                    case 'toxic': return 600;
                    case 'tank': return 400;
                    case 'fast': return 300;
                    case 'spitter': return 350;
                    case 'sniper': return 1500; // Alcance muito maior para snipers
                    case 'boss': return 500;
                    default: return 300;
                }
            }
            
            getDamage() {
                switch (this.type) {
                    case 'runner': return 8;
                    case 'brute': return 15;
                    case 'crawler': return 5;
                    case 'toxic': return 12;
                    case 'tank': return 20;
                    case 'fast': return 6;
                    case 'spitter': return 5;
                    case 'sniper': return 15;
                    case 'boss': return 30;
                    default: return 10;
                }
            }
            
            getColor() {
                switch (this.type) {
                    case 'runner': return '#c78f6b';
                    case 'brute': return '#6b8fbb';
                    case 'crawler': return '#6b8f6b';
                    case 'toxic': return '#8fbb8f';
                    case 'tank': return '#ff8800';
                    case 'fast': return '#aa55ff';
                    case 'spitter': return '#55aaff';
                    case 'sniper': return '#5555ff';
                    case 'boss': return '#ff0000';
                    default: return '#8fbb6b';
                }
            }

            getCoinValue() {
                switch (this.type) {
                    case 'runner': return 3;
                    case 'brute': return 5;
                    case 'crawler': return 2;
                    case 'toxic': return 4;
                    case 'tank': return 15;
                    case 'fast': return 10;
                    case 'spitter': return 13;
                    case 'sniper': return 12;
                    case 'boss': return 100;
                    default: return 2;
                }
            }

            update() {
                const player = gameState.player;
                const dx = player.x - this.x;
                const dy = player.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (this.isSniper) {
                    // Snipers t√™m alcance total do mapa
                    if (distance < this.detectionRange || this.isSniper) {
                        if (distance < 200) {
                            this.retreating = true;
                            const angle = Math.atan2(dy, dx);
                            this.x -= Math.cos(angle) * this.speed;
                            this.y -= Math.sin(angle) * this.speed;
                        } else {
                            this.retreating = false;
                        }
                        
                        if (!this.retreating && Date.now() - this.lastSniperShot > 7000) {
                            this.lastSniperShot = Date.now();
                            const angle = Math.atan2(dy, dx);
                            gameState.sniperBullets.push(new SniperBullet(
                                this.x + this.width / 2,
                                this.y + this.height / 2,
                                angle
                            ));
                        }
                    }
                } else if (distance < this.detectionRange) {
                    const angle = Math.atan2(dy, dx);
                    this.x += Math.cos(angle) * this.speed;
                    this.y += Math.sin(angle) * this.speed;
                    
                    if (distance < (this.type === 'boss' ? 60 : 40) && this.attackCooldown <= 0) {
                        player.takeDamage(this.damage);
                        this.attackCooldown = this.type === 'boss' ? 30 : 60;
                    }
                    
                    if (this.type === 'spitter' && Date.now() - this.lastAcidShot > 4000 && distance < 300) {
                        this.lastAcidShot = Date.now();
                        gameState.acidBullets.push(new AcidBullet(
                            this.x + this.width / 2,
                            this.y + this.height / 2,
                            angle
                        ));
                    }
                    
                    if (this.type === 'boss') {
                        if (Date.now() - this.lastBossAttack > 3000 && distance < 500) {
                            this.lastBossAttack = Date.now();
                            
                            for (let i = 0; i < 3; i++) {
                                const spread = (i - 1) * Math.PI / 8;
                                gameState.bossProjectiles.push(new BossProjectile(
                                    this.x + this.width/2,
                                    this.y + this.height/2,
                                    angle + spread
                                ));
                            }
                        }
                        
                        if (!gameState.bossVomitCharging && Math.random() < 0.01) {
                            gameState.bossVomitCharging = true;
                            gameState.bossVomitChargeTime = 0;
                        }
                        
                        if (gameState.bossVomitCharging) {
                            gameState.bossVomitChargeTime++;
                            
                            if (gameState.bossVomitChargeTime >= 300) {
                                gameState.bossVomitCharging = false;
                                gameState.bossVomits.push(new BossVomit(
                                    this.x + this.width/2,
                                    this.y + this.height/2,
                                    angle
                                ));
                            }
                        }
                    }
                } else {
                    if (Math.random() < 0.02) {
                        this.randomAngle = Math.random() * Math.PI * 2;
                    }
                    this.x += Math.cos(this.randomAngle) * this.speed * 0.5;
                    this.y += Math.sin(this.randomAngle) * this.speed * 0.5;
                }

                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.specialAbilityCooldown > 0) this.specialAbilityCooldown--;

                if (this.laserDamageTimer > 0) {
                    this.laserDamageTimer--;
                    if (this.laserDamageTimer % 6 === 0) {
                        this.takeDamage(100);
                    }
                }

                this.x = Math.max(0, Math.min(config.width - this.width, this.x));
                this.y = Math.max(0, Math.min(config.height - this.height, this.y));
            }

            draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.beginPath();
                ctx.ellipse(
                    this.x + this.width / 2,
                    this.y + this.height - 5,
                    this.width / 2,
                    this.width / 6,
                    0, 0, Math.PI * 2
                );
                ctx.fill();
                
                let sprite;
                switch (this.type) {
                    case 'runner': sprite = sprites.zombies.runner; break;
                    case 'brute': sprite = sprites.zombies.brute; break;
                    case 'crawler': sprite = sprites.zombies.crawler; break;
                    case 'toxic': sprite = sprites.zombies.toxic; break;
                    case 'tank': sprite = sprites.zombies.tank; break;
                    case 'fast': sprite = sprites.zombies.fast; break;
                    case 'spitter': sprite = sprites.zombies.spitter; break;
                    case 'sniper': sprite = sprites.zombies.sniper; break;
                    case 'boss': sprite = sprites.zombies.boss; break;
                    default: sprite = sprites.zombies.normal;
                }
                
                ctx.drawImage(sprite, this.x, this.y, this.width, this.height);
                
                if (this.health < this.getMaxHealth() * difficultySettings[gameState.difficulty].zombieHealthMultiplier) {
                    ctx.fillStyle = '#300';
                    ctx.fillRect(this.x, this.y - 12, this.width, 5);
                    ctx.fillStyle = this.type === 'boss' ? '#f0f' : '#f00';
                    ctx.fillRect(this.x, this.y - 12, this.width * (this.health / (this.getMaxHealth() * difficultySettings[gameState.difficulty].zombieHealthMultiplier)), 5);
                }
                
                if (this.laserDamageTimer > 0) {
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (this.type === 'boss' && gameState.bossVomitCharging) {
                    const chargePercent = gameState.bossVomitChargeTime / 300;
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2 - 20, 10 * chargePercent, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            takeDamage(amount) {
                if (this.type === 'boss') {
                    const isProjectileDamage = gameState.bullets.length > 0 || 
                                             (gameState.grenades.length > 0 && gameState.grenades.some(g => !g.exploded));
                    
                    if (isProjectileDamage) {
                        amount *= 0.5;
                    }
                }
                
                this.health -= amount;
                if (this.health <= 0) {
                    // Aplicar multiplicador de drops baseado na dificuldade
                    const difficulty = difficultySettings[gameState.difficulty];
                    
                    gameState.items.push({
                        type: 'coin',
                        x: this.x,
                        y: this.y,
                        width: 20,
                        height: 20,
                        value: this.coinValue
                    });
                    
                    let dropChance = this.getDropChance() * difficulty.itemDropMultiplier;
                    
                    const numDrops = this.getNumDrops();
                    for (let i = 0; i < numDrops; i++) {
                        if (Math.random() < dropChance) {
                            this.dropItem();
                        }
                    }
                    
                    if (this.type === 'boss' && Math.random() < 0.2) {
                        gameState.items.push({
                            type: 'laserRifle',
                            x: this.x,
                            y: this.y,
                            width: 30,
                            height: 30
                        });
                        gameState.stats.bossesKilled++;
                    }
                    
                    gameState.coins += this.coinValue;
                    gameState.stats.zombiesKilled++;
                    updateCoinUI();
                    
                    this.createDeathEffect();
                    
                    if (this.type === 'boss') {
                        gameState.bossSpawned = false;
                        gameState.bossAlive = false;
                        endNight();
                    }
                    
                    const index = gameState.zombies.indexOf(this);
                    if (index !== -1) gameState.zombies.splice(index, 1);
                    gameState.zombiesSpawned--;
                }
            }
            
            createDeathEffect() {
                if (this.type === 'boss') {
                    gameState.deathEffects.push({
                        type: 'boss',
                        x: this.x + this.width/2,
                        y: this.y + this.height/2,
                        radius: 40,
                        color: '#ff0000',
                        alpha: 0.8,
                        timer: 60,
                        maxTimer: 60
                    });
                    
                    for (let i = 0; i < 50; i++) {
                        createParticle(
                            this.x + this.width/2,
                            this.y + this.height/2,
                            (Math.random() - 0.5) * 10,
                            (Math.random() - 0.5) * 10,
                            '#ff0000',
                            90
                        );
                    }
                } else {
                    gameState.deathEffects.push({
                        type: 'blood',
                        x: this.x + this.width/2,
                        y: this.y + this.height/2,
                        radius: 30,
                        particles: 12,
                        color: '#ff0000',
                        alpha: 0.7,
                        timer: 45,
                        maxTimer: 45
                    });
                    
                    for (let i = 0; i < 15; i++) {
                        createParticle(
                            this.x + this.width/2,
                            this.y + this.height/2,
                            (Math.random() - 0.5) * 6,
                            (Math.random() - 0.5) * 6,
                            '#ff0000',
                            60
                        );
                    }
                }
            }
            
            getDropChance() {
                switch (this.type) {
                    case 'runner': return 0.1;
                    case 'brute': return 0.2;
                    case 'crawler': return 0.05;
                    case 'toxic': return 0.15;
                    case 'tank': return 0.3;
                    case 'fast': return 0.25;
                    case 'spitter': return 0.25;
                    case 'sniper': return 0.3;
                    case 'boss': return 0.8;
                    default: return 0.1;
                }
            }
            
            getNumDrops() {
                const baseChance = this.getDropChance();
                const rand = Math.random();
                
                if (rand < baseChance * 0.05) return 5;
                if (rand < baseChance * 0.1) return 4;
                if (rand < baseChance * 0.2) return 3;
                if (rand < baseChance * 0.4) return 2;
                return 1;
            }
            
            dropItem() {
                const items = [
                    { type: 'pistolAmmo', chance: this.getCommonItemChance(), rarity: 'common' },
                    { type: 'medkit', chance: this.getCommonItemChance(), rarity: 'common' },
                    { type: 'shotgunAmmo', chance: this.getUncommonItemChance(), rarity: 'uncommon' },
                    { type: 'grenade', chance: this.getEpicItemChance(), rarity: 'epic' },
                    { type: 'laserAmmo', chance: this.getLegendaryItemChance(), rarity: 'legendary' }
                ];
                
                let selectedItem = null;
                let roll = Math.random();
                
                for (const item of items) {
                    if (roll < item.chance) {
                        selectedItem = item;
                        break;
                    }
                    roll -= item.chance;
                }
                
                if (selectedItem && (selectedItem.type !== 'laserAmmo' || gameState.hasLaserRifle)) {
                    gameState.items.push({
                        type: selectedItem.type,
                        x: this.x + (Math.random() - 0.5) * 30,
                        y: this.y + (Math.random() - 0.5) * 30,
                        width: 20,
                        height: 20,
                        rarity: selectedItem.rarity
                    });
                }
            }
            
            getCommonItemChance() {
                switch (this.type) {
                    case 'runner': return 0.7;
                    case 'brute': return 0.5;
                    case 'crawler': return 0.8;
                    case 'toxic': return 0.6;
                    case 'tank': return 0.3;
                    case 'fast': return 0.4;
                    case 'spitter': return 0.4;
                    case 'sniper': return 0.5;
                    case 'boss': return 0.1;
                    default: return 0.7;
                }
            }
            
            getUncommonItemChance() {
                switch (this.type) {
                    case 'runner': return 0.2;
                    case 'brute': return 0.3;
                    case 'crawler': return 0.1;
                    case 'toxic': return 0.2;
                    case 'tank': return 0.3;
                    case 'fast': return 0.3;
                    case 'spitter': return 0.3;
                    case 'sniper': return 0.3;
                    case 'boss': return 0.2;
                    default: return 0.2;
                }
            }
            
            getEpicItemChance() {
                switch (this.type) {
                    case 'runner': return 0.0;
                    case 'brute': return 0.05;
                    case 'crawler': return 0.0;
                    case 'toxic': return 0.05;
                    case 'tank': return 0.15;
                    case 'fast': return 0.1;
                    case 'spitter': return 0.1;
                    case 'sniper': return 0.1;
                    case 'boss': return 0.4;
                    default: return 0.0;
                }
            }
            
            getLegendaryItemChance() {
                switch (this.type) {
                    case 'runner': return 0.0;
                    case 'brute': return 0.0;
                    case 'crawler': return 0.0;
                    case 'toxic': return 0.0;
                    case 'tank': return 0.05;
                    case 'fast': return 0.0;
                    case 'spitter': return 0.05;
                    case 'sniper': return 0.05;
                    case 'boss': return 0.3;
                    default: return 0.0;
                }
            }
            
            applyLaserDamage() {
                this.laserDamageTimer = 42;
            }
        }

        class Bullet {
            constructor(x, y, angle, type = 'pistol') {
                this.x = x;
                this.y = y;
                this.speed = type === 'pistol' ? 15 : 12;
                this.angle = angle;
                this.damage = type === 'pistol' ? 35 * gameState.player.damageMultiplier : 28 * gameState.player.damageMultiplier;
                this.lifetime = type === 'pistol' ? 70 : 50;
                this.type = type;
                this.spread = type === 'pistol' ? 0 : Math.PI / 16;
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.lifetime--;

                gameState.zombies.forEach(zombie => {
                    if (
                        this.x > zombie.x && this.x < zombie.x + zombie.width &&
                        this.y > zombie.y && this.y < zombie.y + zombie.height
                    ) {
                        zombie.takeDamage(this.damage);
                        this.lifetime = 0;
                    }
                });

                for (const obstacle of gameState.obstacles) {
                    if (
                        this.x > obstacle.x && this.x < obstacle.x + obstacle.width &&
                        this.y > obstacle.y && this.y < obstacle.y + obstacle.height
                    ) {
                        this.lifetime = 0;
                        break;
                    }
                }
            }

            draw() {
                ctx.fillStyle = this.type === 'pistol' ? '#ffcc55' : '#ffaa00';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.type === 'pistol' ? 3 : 5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = this.type === 'pistol' ? 'rgba(255, 200, 0, 0.5)' : 'rgba(255, 170, 0, 0.5)';
                ctx.lineWidth = this.type === 'pistol' ? 1 : 2;
                ctx.beginPath();
                ctx.moveTo(
                    this.x - Math.cos(this.angle) * 10,
                    this.y - Math.sin(this.angle) * 10
                );
                ctx.lineTo(this.x, this.y);
                ctx.stroke();
            }
        }
    </script>
</body>
</html>